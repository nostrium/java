{
  "id": "4756",
  "title": "Booting XP setup from an 8Gb flash drive - questions",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "36151",
      "timestamp": "2008-05-24T16:22:56+00:00",
      "author": "Legoman",
      "content": "Hi all,  \n\nI\u0027ve spent this morning getting an 8Gb Flash drive booting XP boot.ini using a combination of HP USB Disk Storage Format Tool, Ranish Partition Manager and bootsect.exe :wink:   \n\nMy aim is to use the USB_Multiboot script for text mode setup of Windows XP.  \n\nIt was an interesting experience and I have a few questions for the forum:  \n\nDoes it matter what type of IPL is in the MBR to boot a USB stick? The IPL appears to be an HP modified version of a standard MS-DOS IPL.  \n\nDoes the partition have to start at CHS 0,1,1? I understand that LBA sector 63 defines a USB-HDD and LBA sector 32 defines a USB-ZIP (removable?). Is this used by the BIOS or the OS?  \n\nDoes the partition have to occupy the entire USB stick? In order to have a FAT16X (type 0E) partition I created a 1.9Gb partition. Over 6Gb is unallocated space.  \n\nIn the boot.ini file I have set **rdisk(1)** in the ARC paths. What does this do? Does it tell the PC that the disk/partition is on a different bus (i.e. USB)?  \n\nDoes the disk number in the bootsector at offset 0x24h have to be 0x80h (128)?  \n\nI\u0027d be very grateful if anyone has any comments or answers.  \n\nThank you.   \n"
    },
    {
      "id": "36157",
      "timestamp": "2008-05-24T17:22:01+00:00",
      "author": "was_jaclaz",
      "content": "Hmmm, :wink:, lots of questions!  \n\nLet\u0027s see:  \n\n\u003e Does it matter what type of IPL is in the MBR to boot a USB stick? The IPL appears to be an HP modified version of a standard MS-DOS IPL.\nNo. It does not matter theoretically, the HP utility uses a W2K/XP MBR, modified to skip some checks, probably for a wider compatibility with some mothernoard BIOS.  \nRead this:  \n[http://www.boot-land...?showtopic\u003d2246](http://www.boot-land.net/forums/?showtopic\u003d2246 \"External link\")  \n[http://www.boot-land...opic\u003d2246\\\u0026st\u003d15](http://www.boot-land.net/forums/?showtopic\u003d2246\u0026st\u003d15 \"External link\")  \n\nAnd this:  \n[http://www.boot-land...?showtopic\u003d4476](http://www.boot-land.net/forums/?showtopic\u003d4476 \"External link\")  \n(Vista and bitlocker may be a \"special\" case)  \n\n\u003e Does the partition have to start at CHS 0,1,1? I understand that LBA sector 63 defines a USB-HDD and LBA sector 32 defines a USB-ZIP (removable?). Is this used by the BIOS or the OS?\nNot really, it depends on the geometry of the drive as the BIOS \"senses\" it or if you prefer as the controller on the USB device reports it.  \nRead this:  \n[http://home.graffiti...B/USBstick.html](http://home.graffiti.net/jaclaz:graffiti.net/Projects/USB/USBstick.html \"External link\")  \nYou can have a bootsector as 0/0/32. ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)  \n\nOn some Operating Systems, (usually old DOS versions), not respecting \"cylinder/head boundaries\" may cause problems:  \n[http://en.wikipedia....der-head-sector](http://en.wikipedia.org/wiki/Cylinder-head-sector \"External link\")  \n\nsome utilities (Partition Magic for example) won\u0027t like it as well:  \n[http://www.911cd.net...showtopic\u003d21186](http://www.911cd.net/forums//index.php?showtopic\u003d21186 \"External link\")  \neven if it is harmless on most current OS\u0027s and filesystems in NORMAL operation, it is not recommended to have partitions END on a non-boundary, (this would likely cause overlapping partitions, expecially if resizing them) but experience with first partition starting at a non-head boundary never caused a problem to me with any OS I tried.  \n\nIf geometry is reported as ***n*** x255x63 , as most (read almost ALL) BIOS and devices will do, or if it is sensed as ***n*** x128x63 or ***n*** x16x63, 0/1/1 is LBA 63, if the device is \"sensed\" as ***n*** x64x32, as for example Qemu does for some smallish hard disk images, 0/1/1 will be LBA 32.  \n\nIf you use a LBA format (partition ID 0C,0E or 07), the CHS information should be totally ignored.  \n[http://www.win.tue.n...on_types-1.html](http://www.win.tue.nl/~aeb/partitions/partition_types-1.html \"External link\")  \n\nRead this also:  \n[http://www.boot-land...?showtopic\u003d4488](http://www.boot-land.net/forums/?showtopic\u003d4488 \"External link\")  \nAND links therein, where you will find more details about the \"particularity\" of ZIP drives, here also:  \n[http://www.win.tue.n.../zip/zip-1.html](http://www.win.tue.nl/~aeb/linux/zip/zip-1.html \"External link\")  \n\nAnd, if you are familiar with batch language, have a look at this too:  \n[http://www.boot-land...?showtopic\u003d4488](http://www.boot-land.net/forums/?showtopic\u003d4488 \"External link\")  \n\nAnd to this:  \n[http://www.911cd.net...showtopic\u003d20089](http://www.911cd.net/forums//index.php?showtopic\u003d20089 \"External link\")  \n(which you can use directly to \"automagically\" do what you did manually)  \n\n\u003cbr /\u003e\n\n\u003e Does the partition have to occupy the entire USB stick? In order to have a FAT16X (type 0E) partition I created a 1.9Gb partition. Over 6Gb is unallocated space.\nNo, if you use a \"limited in size\" filesystem, you\u0027ll have unused space, but nothing prevents you from having mutiple partitions on the device, though you will need (to access them all from 2K/XP/2003), to either find the \"manufacturer tool\" to flip the \"removable\" bit or use a filter driver, read this:  \n[http://www.boot-land...?showtopic\u003d4560](http://www.boot-land.net/forums/?showtopic\u003d4560 \"External link\")  \n\n\u003e In the boot.ini file I have set **rdisk(1)** in the ARC paths. What does this do? Does it tell the PC that the disk/partition is on a different bus (i.e. USB)?\nNo \"racism\" about different buses, just the number of the disk, the one you boot from is always first drive (or disk 0)  \nArcpath syntax, read here:  \n[http://www.msfn.org/...-...0.html\\\u0026st\u003d2](http://www.msfn.org/board/Discovery-of-an-Unusual-recovery-t33030.html\u0026st\u003d2 \"External link\")  \n[http://www.msfn.org/...f...5.html\\\u0026st\u003d2](http://www.msfn.org/board/BOOTINI-and-different-hard-drive-t25365.html\u0026st\u003d2 \"External link\")  \n\n\u003e Does the disk number in the bootsector at offset 0x24h have to be 0x80h (128)?\nYes, this is not negotiable. ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)  \n\nBut if you want to boot from a non-80 in the bootsector partition, you could well use a workaround like directly chainloading system file or loader through grub4dos.  \nBrowse a bit in the grub4dos section of the forum, you\u0027ll find several interesting links/ways, ideas:  \n[http://www.boot-land...s/?showforum\u003d66](http://www.boot-land.net/forums/?showforum\u003d66 \"External link\")  \n\nand here is a more general guide:  \n[http://www.911cd.net...showtopic\u003d18846](http://www.911cd.net/forums//index.php?showtopic\u003d18846 \"External link\")  \n\n\u003cbr /\u003e\n\nI guess you have some homework to do now, ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif) but you actually ASKED for it! ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)  \n\n\u003cbr /\u003e\n\njaclaz   \n"
    },
    {
      "id": "36165",
      "timestamp": "2008-05-24T19:03:31+00:00",
      "author": "Legoman",
      "content": "\u003e And to this:  \n\u003e [http://www.911cd.net...showtopic\u003d20089](http://www.911cd.net/forums//index.php?showtopic\u003d20089 \"External link\")  \n\u003e (which you can use directly to \"automagically\" do what you did manually)\nI do intend to use that to put the XP setup files into the partition on the stick but I couldn\u0027t see how it would create the partition.  \n\nPeToUSB wouldn\u0027t format the stick because it was over 2Gb in size.  \n\nI didn\u0027t want to format the entire space with a FAT32X partition because I understand that this is very slow when installing XP from USB.  \n\nRanish Partition Manager flipped when it saw the superfloppy bootsector in place of the MBR (came up with a weird error box) so I couldn\u0027t use that.  \n\nThe HP tool did create a FAT32 partition occupying the entire space and wrote an MBR to the stick.  \n\nRPM then \"saw\" the stick as a hard disk and I was able to delete the FAT32 partition, create a 1.9Gb FAT16X partition and format it. After that I used bootsect.exe to write an NTLDR bootsector into the partition.  \n\nUnfortunately, when I formatted the partition my two existing hard drives were also visible to RPM so it set the drive number in the bootsector to 130 (0x82h). This caused a few issues when i tried to boot the USB stick :wink:  \n\nOnly when I realised this did I hexedit the boot sector to change offset 0x24h to 0x80h! Hence, my query regarding this ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)  \n\n\u003cbr /\u003e\n\n\u003e No, if you use a \"limited in size\" filesystem, you\u0027ll have unused space, but nothing prevents you from having mutiple partitions on the device, though you will need (to access them all from 2K/XP/2003), to either find the \"manufacturer tool\" to flip the \"removable\" bit or use a filter driver, read this:  \n\u003e [http://www.boot-land...?showtopic\u003d4560](http://www.boot-land.net/forums/?showtopic\u003d4560 \"External link\")\n[http://www.boot-land...?...ost\\\u0026p\u003d34730](http://www.boot-land.net/forums/index.php?showtopic\u003d4560\u0026view\u003dfindpost\u0026p\u003d34730 \"External link\") is a great explanation of the different \"modes\" that USB sticks can be in. That\u0027s increased my understanding. Thanks.  \n\n\u003cbr /\u003e\n\nTo further the discussion I\u0027d like to use RPM as the IPL in the MBR on the USB stick and then switch different partitions in and out of the partition table as needed. Can you see any reason not do this?  \n\n\u003cbr /\u003e\n\n\u003e I guess you have some homework to do now, ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif) but you actually ASKED for it! ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)\nIndeed I did ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)   \n"
    },
    {
      "id": "36189",
      "timestamp": "2008-05-25T02:38:52+00:00",
      "author": "windrv",
      "content": "Why take all those troubles?  \n\nJust put in your usb stick and run up Diskless Angel to partition it and then disable and remove the usb stick and re-insert it.  \n\nIf you want to have ntfs format, just run up My Computer to do re-formatting.  \n\nThen use grubinst_gui.exe to put the mbr to the usb stick, you could specify what bootfile you want to use by the mbr code put to your usb stick.   \n"
    },
    {
      "id": "36207",
      "timestamp": "2008-05-25T10:53:15+00:00",
      "author": "was_jaclaz",
      "content": "I personally am against writing anything to the the hidden sectors of a disk. (1-62) (like having grub4dos grldr.mbr installed) as there are several utilities (unfortunately widely in use) that won\u0027t interpreter correctly data in those sectors or will overwrite them.  \n\nBut there is NO chance of using anything but grub4dos as it\u0027s features are by far superior to any other bootmanager/bootloader.  \n\nThe \"easy\" solution I found is simply to:  \n1) leave the MBR as is (2K/XP/2003) - or the HP utility modified one.  \n2) chainload grldr from NTLDR/BOOT.INI  \n3) if \"passing through\" NTLDR/BOOT.INI is inconvenient for any reason, change the name of the loader invoked in the bootsector:  \n[http://www.boot-land...?showtopic\u003d2362](http://www.boot-land.net/forums/?showtopic\u003d2362 \"External link\")   \n\nNothing against RPM, mind you, it\u0027s a very convenient app, that I actually love, but it\u0027s a DOS one, and needs rebooting to another OS or using a VM to be used.  \n\nTry Swissknife:  \n[http://www.compuapps.../swissknife.htm](http://www.compuapps.com/Download/swissknife/swissknife.htm \"External link\")  \n\njaclaz   \n"
    },
    {
      "id": "36276",
      "timestamp": "2008-05-26T10:41:00+00:00",
      "author": "Legoman",
      "content": "O.K., I\u0027m continuing my adventure with this 8Gb UFD.  \n\nI\u0027ve discovered that to get the flash drive to be recognised as a bootable USB-HDD one (and ONLY one) partition must exist in the MBR partition table and that partition must start at absolute sector 63 (logical head 1).  \n\nIf the partition starts on a cylinder boundary (CHS 1,0,1) then the flash drive is recognised as removable.  \n\nIf more than one partition exists in the partition table then the flash drive is recognised as removable.  \n\nIf only one partition exists but doesn\u0027t start at sector 63 (CHS 0,1,1) then the flash drive is treated as removable.  \n\nI don\u0027t know whether this is a limitation of my BIOS or I\u0027m just misunderstanding things.  \n\nIt seems a bit limiting only to have a single partition on the flash drive. RPM would help as I could switch partitions in and out of the partition table but not if they all have to start at sector 63.  \n\n:wink:   \n"
    },
    {
      "id": "36277",
      "timestamp": "2008-05-26T11:07:02+00:00",
      "author": "was_jaclaz",
      "content": "NO, either we are using different terms or you have a ***very peculiar*** motherboard BIOS.  \n\nBIOS does NOT care whether the stick is seen as \"removable\" or \"fixed\", nor does DOS.  \n\nThe only thing the BIOS ***may*** \"recognize\" is whether the first sector is a MBR or a bootsector, i.e. \"HD like\" or \"superfloppy\".  \n\n2K, XP and 2003 will see the drive as \"removable\" REGARDLESS whether the MBR is there or not, if there is, it will see it as a \"removable\" \"HD like\" device (thus allowing access to one, and only one partition, First active), if there is no MBR, it will see it as \"removable\" \"super-floppy\" device, and this DEPENDS EXCLUSIVELY to the \"fixed/removable\" bit is set (or filtered by a filter driver).   \n\nI guess that what you really mean by this:  \n\u003e I\u0027ve discovered that to get the flash drive to be recognised as a bootable USB-HDD one (and ONLY one) partition must exist in the MBR partition table and that partition must start at absolute sector 63 (logical head 1).  \n\u003e\n\u003e If the partition starts on a cylinder boundary (CHS 1,0,1) then the flash drive is recognised as removable.  \n\u003e\n\u003e If more than one partition exists in the partition table then the flash drive is recognised as removable.  \n\u003e\n\u003e If only one partition exists but doesn\u0027t start at sector 63 (CHS 0,1,1) then the flash drive is treated as removable.\n\nIs:  \n\u003e I managed to boot off the USB stick only if one partition exists on the stick and starts at absolute sector 63.  \n\u003e\n\u003e I wasn\u0027t able to boot if the partition starts on a cylinder boundary (CHS 1,0,1)  \n\u003e\n\u003e I wasn\u0027t able to boot if more than one partition exists in the partition table.  \n\u003e\n\u003e I wasn\u0027t able to boot if only one partition exists but doesn\u0027t start at sector 63 (CHS 0,1,1)\n\nDo the following:  \n1) re-create the stick formatting in the various ways you reported (working and not working)  \n2) save each MBR and partition(s) bootsector using an app like HDhacker:  \n[http://dimio.altervista.org/eng/](http://dimio.altervista.org/eng/ \"External link\")  \ngiving them \"understable\" filenames, like:  \ntest_01.MBR  \ntest_01_part_01.bss  \netc.  \n3) compress them to a .zip or .7z archive.  \n4) attach them to a post where you describe the steps you did for each set of files.  \n\nI\u0027ll have a look at them and maybe I will be able to help you.  \n\njaclaz   \n"
    },
    {
      "id": "36292",
      "timestamp": "2008-05-26T16:04:35+00:00",
      "author": "Legoman",
      "content": "I must have a very peculiar motherboard BIOS then :wink:   \n\nThe motherboard is an ASUS M2N32-WS Pro.  \n\nI\u0027ve tried booting from the stick on a second PC and it works wherever the partition starts and when there are two partitions on the stick so I\u0027m sure the process I am using is correct.  \n\nFor the record:  \n\n1) Format entire stick using the HP USB Disk Storage Format Tool v2.0.6 (GUI) with a FAT32 partition  \n2) Use RPM to delete the FAT32 partition then create a 1.9Gb FAT16X partition starting at sector 63  \n3) Use bootsect to write an NTLDR bootsector to the partition  \nThe IPL in the MBR remains unchanged  \n\n\u003cbr /\u003e\n\nI note that both PeToUSB and the HP utility both start their partitions at sector 63 (CHS 0,1,1) and only create a single partition. I wonder whether this is for enhanced compatability with picky motherboards like mine?  \n\nI don\u0027t doubt that this restriction is not enforced on other motherboards; indeed I have proved that on my second PC. However, it appears that some BIOSs will only recognise a USB stick as a USB-HDD if it is partitioned in a particular way.   \n"
    },
    {
      "id": "36321",
      "timestamp": "2008-05-26T20:22:59+00:00",
      "author": "was_jaclaz",
      "content": "The only ones that does make some sense (though of course completely stupid :wink:) is:  \nFirst partition must start at 0/1/1  \nas this is the normal way any DOS drive has been fdisked/formatted.  \n\nThe BIOS should completely ignore the presence of other partitions.  \n\n(I assume as given that you already tried different BIOS settings on the ASUS)  \n\nWhat happens if you change the partition ID of second and subsequent partitions to a \"Hidden\" one?   \n\nI would also be curious to know if changing the partition type from 06 (CHS) to 0E (LBA) makes any difference.  \n\n\u003cbr /\u003e\n\njaclaz   \n"
    },
    {
      "id": "36411",
      "timestamp": "2008-05-28T19:27:52+00:00",
      "author": "Legoman",
      "content": "I think that the BIOS may be treating the USB-HDD as a psuedo USB-FDD, hence the requirement to only have a single partition starting at absolute sector 63 (0,1,1).  \n\nThe original (only) partition is LBA enabled (type 0E). I\u0027ve tried setting a second partition to type 1E and type 16 (hidden) to no avail. It won\u0027t tolerate any more than one entry of any type in the partition table.  \n\nI\u0027m not overly fussed as I can manually add/remove other entries to the partition table when using it on other PCs.   \n"
    }
  ]
}