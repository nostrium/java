{
  "id": "17827",
  "title": "Flat PE3 boot from USB fails with BSOD",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "163649",
      "timestamp": "2012-11-30T13:18:58+00:00",
      "author": "pscEx",
      "content": "To avoid questions about the \"Why\":  \nI\u0027m working on a \"barebone\" version of multiPE, caused by the \"competition\".  \nAnd here the easiest and fastest way is to try and error by adding / deleting files in a bootable USB stick, and test the boot.  \n\nInspite I think that the failure appears after all boot tasks, here the BCD:  \n(BTW: Same bad result with locale en-US)  \nSpoiler  \n\nWindows Boot Manager  \n--------------------  \nidentifier {bootmgr}  \ndevice boot  \ndescription Windows Boot Manager  \nlocale de-DE  \ninherit {globalsettings}  \ndefault {default}  \ndisplayorder {default}  \ntoolsdisplayorder {memdiag}  \ntimeout 30  \n\nWindows Boot Loader  \n-------------------  \nidentifier {default}  \ndevice boot  \npath \\\\windows\\\\system32\\\\boot\\\\winload.exe  \ndescription Windows Setup  \nlocale de-DE  \ninherit {bootloadersettings}  \nosdevice boot  \nsystemroot \\\\windows  \ndetecthal Yes  \nwinpe Yes  \nbootlog Yes  \nsos Yes  \nems Yes  \n\nWindows Memory Tester  \n---------------------  \nidentifier {memdiag}  \ndevice boot  \npath \\\\boot\\\\memtest.exe  \ndescription Windows Memory Diagnostic  \nlocale de-DE  \ninherit {globalsettings}  \n\nEMS Settings  \n------------  \nidentifier {emssettings}  \nbootems Yes  \n\nDebugger Settings  \n-----------------  \nidentifier {dbgsettings}  \ndebugtype Serial  \ndebugport 1  \nbaudrate 115200  \n\nGlobal Settings  \n---------------  \nidentifier {globalsettings}  \ninherit {dbgsettings}  \n{emssettings}  \n\nBoot Loader Settings  \n--------------------  \nidentifier {bootloadersettings}  \ninherit {globalsettings}  \n{hypervisorsettings}  \n\nHypervisor Settings  \n-------------------  \nidentifier {hypervisorsettings}  \ndescription Hypervisor Settings  \nhypervisordebugtype Serial  \nhypervisordebugport 1  \nhypervisorbaudrate 115200  \n\nDevice options  \n--------------  \nidentifier {7619dcc8-fafe-11d9-b411-000476eba25f}  \nramdisksdidevice boot  \nramdisksdipath \\\\boot\\\\boot.sdi  \n\n\u003cbr /\u003e\n\nWhen I build a flat target and create an ISO from it, it boots fine.  \nBut the copy to an USB stick fails booting. The stick is prepared with rmpartusb and works fine with WIM based PEs and flat XP PEs.  \n\nWhen booting from the stick, according to the bcd sos option, drivers are reported as loaded. Also the correct kernel and hal are loaded.  \nLast loaded driver is disk.sys.  \n\nThen the screen is cleared, and a message about the used kernel apperars, including the info that bootlog is active.  \n\nAfter several seconds the BSOD appears with 0x0000007B.  \n**EDIT by author: the misspelled 7F has been changed to the correct 7b**   \nThe bootlog ntbtlog.txt is not generated.  \n\nAll google trials I made, did not find a remarkable solution.  \nTherefore @All: Please reanimate your magic crystal balls, polish them, and tell them my issue, and hopefully get a response which I can use.  \n\nPeter   \n\n**Edited by pscEx, 01 December 2012 - 06:11 PM.**\n"
    },
    {
      "id": "163651",
      "timestamp": "2012-11-30T13:27:12+00:00",
      "author": "steve6375",
      "content": "You say you make an ISO and it boots fine - does it boot from a DVD/CD or from the ISO file placed on a bootable USB drive?  \nDoes the USB drive boot under QEMU using RMPrepUSB **Test using QEMU** button?  \nFinally, will the **same** USB port of the **same** computer boot any sort of WinPE3 flat file from a USB drive ?   \n"
    },
    {
      "id": "163652",
      "timestamp": "2012-11-30T13:31:15+00:00",
      "author": "pscEx",
      "content": "Thanks, Steve, for the fast answer.  \nThe \"fine booting ISO\" is booted in an emulator.  \n\nI\u0027ll try to answer all of your questions. But that will take some (latin) minutes.  \n\n(Can you give some more explanation, or a link about the QEMU question?)  \n\nPeter   \n"
    },
    {
      "id": "163661",
      "timestamp": "2012-11-30T15:20:19+00:00",
      "author": "pscEx",
      "content": "Sorry, I made a mistake.  \n\nThe ISO is also not booting. Maybe in my tests I exchanged some iso-s.  \n\nSeems to be my homework now. No need of the communitie\u0027s magic crystal balls  \n\nPeter   \n"
    },
    {
      "id": "163664",
      "timestamp": "2012-11-30T16:36:22+00:00",
      "author": "Sha0",
      "content": "\u003e Sorry, I made a mistake.  \n**7E** seems a bit odd. If it\u0027s really not that there\u0027s a funny driver causing the problem, could it be that your **osdevice** isn\u0027t working? **bcdedit /enum all /v** might be interesting, too.   \n"
    },
    {
      "id": "163671",
      "timestamp": "2012-11-30T18:06:13+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e **7E** seems a bit odd. If it\u0027s really not that there\u0027s a funny driver causing the problem, could it be that your **osdevice** isn\u0027t working? **bcdedit /enum all /v** might be interesting, too.  \nWasn\u0027t it 7**F**?![:unsure:](http://reboot.pro/public/style_emoticons/default/unsure.png)  \n\n![:cheers:](http://reboot.pro/public/style_emoticons/default/cheers.gif)  \nWonko   \n"
    },
    {
      "id": "163678",
      "timestamp": "2012-12-01T00:11:33+00:00",
      "author": "laddanator",
      "content": "\u003e The stick is prepared with rmpartusb and works fine with WIM based PEs and flat XP PEs.  \n\u003e\n\u003e Peter  \n\nThis may be getting off topic, but how are you flat file booting XP PEs?   \n"
    },
    {
      "id": "163685",
      "timestamp": "2012-12-01T02:27:09+00:00",
      "author": "Sha0",
      "content": "\u003e Wasn\u0027t it 7**F**? ![:unsure:](http://reboot.pro/public/style_emoticons/default/unsure.png)  \nOops. You\u0027re right. Well that\u0027s even stranger! What are the other codes on the screen, pscEx?  \n\n\u003e This may be getting off topic, but how are you flat file booting XP PEs?  \nThe **osdevice** option for the **BCD** entry determines what the **Windows** (**PE** or non-PE) will consider to be the boot volume. If that\u0027s a RAM disk established with an **.SDI** file with a **.WIM** FS layered on top, so be it. Otherwise, you can choose some other volume that\u0027s available.  \n\nShort answer: **bcdedit** can let you change the osdevice option.  \n\nP. S. Remember the following confusion:\n\n* The system volume is the filesystem where **BootMgr** and the **BCD** live; used for booting\n* The boot volume is where the operating system lives\n\n![:eek:](http://reboot.pro/public/style_emoticons/default/eek.gif) ![:confused1:](http://reboot.pro/public/style_emoticons/default/confused1.gif) ![:loleverybody:](http://reboot.pro/public/style_emoticons/default/loleverybody.gif) ![:buehehe:](http://reboot.pro/public/style_emoticons/default/buehehe.gif)   \n"
    },
    {
      "id": "163698",
      "timestamp": "2012-12-01T12:05:08+00:00",
      "author": "pscEx",
      "content": "Some wanted info:  \nThe intermediate troubles came from a wrong osdevice in BCD, which I made to try to start USB with ISO on it.  \nEveryrthing now again works regularly.  \nAll different PEs are made using the unchanged original created target directory.  \n(flat) ISO boots from VirualBox and from really burned CD.  \n\n(flat) USB stick as boot drive for qemu and VMWare boots fine (qemu it needs \u0027endless\u0027 time)  \n\n(flat) USB stick as boot drive fails (see description in the first post)..  \n\n@Sha0  \nThe complete error code is  \n0x0000007B 0x80786B58 0xC0000034 0x00000000 0x00000000  \n(sorry for my first misspelling)  \n\n@Steve:  \nI never tried a different flat PE3.  \nI\u0027m still trying to bring the (flat) ISO to the USB stick.  \nqEmu Test:  \n[![qemu.gif](http://reboot.pro/uploads/monthly_12_2012/post-3-0-09746000-1354364029_thumb.gif)](http://reboot.pro/uploads/monthly_12_2012/post-3-0-09746000-1354364029.gif \"qemu.gif - Size: 7.73KB\"){#ipb-attach-url-13993-0-91146100-1676066555}   \nBesides the warning / error messages win7PE boots as in the above described direct qEmu boot.  \n\nPeter   \n"
    },
    {
      "id": "163700",
      "timestamp": "2012-12-01T12:26:37+00:00",
      "author": "Wonko the Sane",
      "content": "Good. :smile:  \n7**B** is not \"queer\" at all.  \n\n![:cheers:](http://reboot.pro/public/style_emoticons/default/cheers.gif)  \nWonko   \n"
    },
    {
      "id": "163703",
      "timestamp": "2012-12-01T15:26:22+00:00",
      "author": "cdob",
      "content": "\u003e 0x0000007B 0x80786B58 0xC0000034 0x00000000 0x00000000\n0x7B is the expected BSOD: missing boot drive.  \nFlat file USB booting is not supported out of the box.  \nUSB drivers are loaded late, the boot drive is not available at flat file boot.  \n\nQemu/VMware may map USB drive to a virtual internal disk, hence no USB booting.  \n\nThere are USB booting hints in Windows 7 gold.  \nAnd there is [Bootable Windows USB Stack (Windows Embedded Standard 7 Service Pack 1)](http://msdn.microsoft.com/en-us/library/ff794567(v\u003dwinembedded.60).aspx \"External link\")  \n\nTry default USB drivers and  \n\n```\nHive_Load,System\n\nReg_Add,0x1,%reg%\\ControlSet001\\Control,BootDriverFlags,28\n\nReg_Add,0x1,%reg%\\ControlSet001\\Control\\PnP,PollBootPartitionTimeout,30000\n\nHive_Unload\n```\n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "163708",
      "timestamp": "2012-12-01T17:26:22+00:00",
      "author": "pscEx",
      "content": "![:clap:](http://reboot.pro/public/style_emoticons/default/clap.gif) ![:clap:](http://reboot.pro/public/style_emoticons/default/clap.gif) ![:clap:](http://reboot.pro/public/style_emoticons/default/clap.gif) ![:clap:](http://reboot.pro/public/style_emoticons/default/clap.gif) ![:clap:](http://reboot.pro/public/style_emoticons/default/clap.gif) ![:clap:](http://reboot.pro/public/style_emoticons/default/clap.gif)  \nThanks, cdob! That brought the success!  \n\nI would like to give you 10 \u0027I like this\u0027. But unfortunatelly I\u0027m limited to give only one.  \n\nI did a small change, following the actual documentation: Set BootDriverFlags to 4.  \nBut I\u0027ll check also 28, later.  \n\nBTW: The \u0027native\u0027 boot of this flat USB stick needs \u0027endless\u0027 time. I estimate about 5 to 10 minutes until the desktop is up.  \nFor the invented tests, I therefore decided, to boot the stick in VMWare. That needs only around one minute to bring the desktop.  \n\nBTW2: Can you give an explanation about PollBootPartitionTimeout? Google and BillyTheDoor do not tell very much.  \n\n\u003cbr /\u003e\n\nPeter   \n"
    },
    {
      "id": "163732",
      "timestamp": "2012-12-03T16:13:00+00:00",
      "author": "cdob",
      "content": "\u003e I did a small change, following the actual documentation: Set BootDriverFlags to 4.  \n\u003e But I\u0027ll check also 28, later.\nWindows 8 uses 28 and 30000 by default.  \nBootDriverFlags is a bit flag: 28 11100 includes 4 00100  \n\nTo clarify: There is no need to set this at WinPE 4.  \n\n\u003e The \u0027native\u0027 boot of this flat USB stick needs \u0027endless\u0027 time.\nThat\u0027s long access time at this stick. Each file access is delayed, flat file reads al lot of files from USB dfrive.  \nUse a fast USB drive (short access time), a USB SSD is nice.  \n\n\u003e For the invented tests, I therefore decided, to boot the stick in VMWare.\nWhich VMware application do you use?  \nHow do you connect the USB stick to virtual machine? USB drive or physicaldisk?  \n\n\u003e Can you give an explanation about PollBootPartitionTimeout?\n\nKB2743013: STOP 0x0000007B error on reboot after Bitlocker drive encryption  \n[http://support.micro....com/kb/2743013](http://support.micro....com/kb/2743013 \"External link\")  \nPollBootPartitionTimeout : NEW VALUE: 0x0001D4C0 (120000 Decimal)  \n\u003e This value configures Windows to wait up to two minutes for the volume to come online during boot. If the timeout value is reached and the volume is not yet online, a STOP 0x00000078 INACCESIBLE_BOOT_DEVICE error will be displayed.\nIt\u0027s a manufactuer typo: 0x7**8**   \n\n120000 Decimal seems to match 120000 miliseconds.  \n\nTherefore PollBootPartitionTimeout 30000 refers to 30 seconds.   \n"
    }
  ]
}