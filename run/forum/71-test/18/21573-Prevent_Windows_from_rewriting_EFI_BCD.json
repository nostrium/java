{
  "id": "21573",
  "title": "Prevent Windows from rewriting EFI \u0026 BCD",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "204328",
      "timestamp": "2017-08-01T10:41:27+00:00",
      "author": "ndog37",
      "content": "With regards to the issue of windows [automatically recreating](https://ubuntuforums.org/showthread.php?t\u003d2294337\u0026p\u003d13383883#post13383883 \"External link\") /EFI/Microsoft/Boot/bootmgfw.efi and /EFI/Microsoft/Boot/BCD is there a tested way to prevent this happening? If you have already come across this and solved it please share your work around.  \n\nsome thoughts  \n1) restrict windows access to efi partition, without breaking booting (considering FAT32 so cannot apply perms)  \n2) make a service to /EFI/Microsoft/Boot nuke itself automatically  \n3) an API to prevent windows writing these files  \n4) [stop windows updates completely](http://jjstellato.blogspot.co.nz/2015/08/disable-automatic-windows-updates.html \"External link\") (would like to avoid this however)  \n5) if all else fails [BCD entry to launch grub2.efi](https://coderwall.com/p/vfyqkg/prevent-windows8-to-register-itself-as-default-boot-entry-in-uefi-systems \"External link\")\n\n**Edited by ndog37, 01 August 2017 - 10:58 AM.**\n"
    },
    {
      "id": "204330",
      "timestamp": "2017-08-01T13:47:37+00:00",
      "author": "Wonko the Sane",
      "content": "1) Besides the many good things that Rufus does, Akeo wrote a NTFS filesystem driver for EFI/UEFI (which should allow to have the BCD and the various boot files on a NTFS volume).\n\nWhether it will work on your setup or if some NTFS permission can actually prevent that, is another thing.\n\n2) and 3) maybe a filter driver?\n\n4) which seems like a good idea, actually.\n\n5) Not a bad workaround, IMHO.\n\nPlease specify (as I believe ![:unsure:](http://reboot.pro/public/style_emoticons/default/unsure.png)) that you are talking of Windows ++**10**++.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204344",
      "timestamp": "2017-08-02T22:30:31+00:00",
      "author": "cdob",
      "content": "\u003e With regards to the issue of windows\nWhat\\*s your situation?  \nWhich firmware (UEFI version and manufacturer release) do you use?  \n\nDoes the UEFI firmware boot the first NVRAM entry?  \n\nDoes the UEFI firmware boot a fixed windows file name?  \ne.g. \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi  \n\nDoes the UEFI firmware boot a default UEFI file name?  \ne.g. \\\\EFI\\\\Boot\\\\bootx64.efi  \n\nGiven one GPT disk with a single FAT32 EFI partition.  \nCreate a second NVRAM entry and set this to default boot.  \nExample, adjust the GUID numbers {919\\*}  \n\n\u003cbr /\u003e\n\nbcdedit /copy {bootmgr} /d \"UEFI \\\\EFI\\\\Boot\\\\bootx64.efi\"  \nbcdedit /set {9190511b-779b-11e7-baff-ea3d13e64229} path \\\\EFI\\\\Boot\\\\bootx64.efi  \nbcdedit /enum firmware  \nbcdedit /set {fwbootmgr} displayorder {9190511b-779b-11e7-baff-ea3d13e64229} {bootmgr} {91905113-779b-11e7-baff-ea3d13e64229} {91905114-779b-11e7-baff-ea3d13e64229} {91905115-779b-11e7-baff-ea3d13e64229} {91905116-779b-11e7-baff-ea3d13e64229}  \n\nmountvol s: /s  \n\nCopy grub2 files to the EFI partition.  \nS:\\\\\\\u003excopy e:\\\\efi s:\\\\efi\\\\ /s /y  \nE:\\\\efi\\\\BOOT\\\\grubx64.efi  \nE:\\\\efi\\\\BOOT\\\\BOOTX64.efi  \nE:\\\\efi\\\\BOOT\\\\grub.cfg  \nE:\\\\efi\\\\BOOT\\\\fonts\\\\unicode.pf2  \n\nnotepad s:\\\\efi\\\\BOOT\\\\grub.cfg  \nmenuentry \"UEFI: Windows /EFI/Microsoft/Boot/bootmgfw.efi\" {  \nchainloader /EFI/Microsoft/Boot/bootmgfw.efi  \n}  \n\nA Windows 10 monthly update is possible. Grub 2 is active still.  \nI doubt a Windows 10 upgrade installation (1607 to 1703), not tested. A windows startup entry \u0027bcdedit /set {fwbootmgr} displayorder \\*\u0027 may be useful.   \n"
    },
    {
      "id": "204350",
      "timestamp": "2017-08-04T16:21:19+00:00",
      "author": "cdob",
      "content": "Or does the strange firmware boot a NVRAM entry name \"Windows Boot manager\"?  \nThen try a almost duplicate name:  \nbcdedit /copy {bootmgr} /d \"Windows Boot manager 2\"  \nDoes the machine boots this?  \n\n\u003cbr /\u003e\n\n\u003cbr /\u003e\n\nUpgrade installation Windows 10 1607 to 1703:  \n1703 DVD inserted, setup.exe launched.  \nAt reboot the UEFI boots to grub still.  \nWindows 10 upgrade does keep the firmware default entry.  \nHowever the installation failed because of this.  \nPress shift F10, run bcdedit /set {fwbootmgr} displayorder {bootmgr}  \nSetup continuoes and 1703 is installed.  \n\n/efi/boot/bootx64.efi is preserved, not overwritten, it\u0027s the grub/shim file still.  \n\nrun bcdedit /set {fwbootmgr} displayorder again, set grub2 as default  \nGrub2 to is the default boot entry again.  \n\n\u003cbr /\u003e\n\nAddional idea:  \nDo not use the fixed UEFI name \\\\EFI\\\\Boot\\\\bootx64.efi  \nUse a \\\\EFI\\\\Boot\\\\shim.efi  \nbcdedit /set {9190511b-779b-11e7-baff-ea3d13e64229} path \\\\EFI\\\\Boot\\\\shim.efi   \n"
    },
    {
      "id": "204369",
      "timestamp": "2017-08-07T10:15:15+00:00",
      "author": "ndog37",
      "content": "HI Wonko and cdob,\n\nYes you are right, windows 10, is the culprit, it likes to ~~break~~ repair the EFI system after an update.\n\nThe option to keep the BCD file in \\\\EFI\\\\Microsoft\\\\Boot seems to be the best, simply because on the various machines, HP acer etc, some machines force to boot \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi, and the windows update continues to generate this file if not present\n\nDoes the UEFI firmware boot a fixed windows file name?  \ne.g. \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi\n\nyes it does\n\nDoes the UEFI firmware boot a default UEFI file name?  \ne.g. \\\\EFI\\\\Boot\\\\bootx64.efi\n\nyes it does (as long as \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi is not present)\n\nand windows likes to restore itself either on boot, or installing windows\n\nI have the grub2.efi and grub2.cfg\n\n/efi/boot/bootx64.efi\n\n/efi/boot/grubx64.efi\n\n/efi/boot/grub.cfg\n\nworking boot windows - as long as UEFI boots from \\\\EFI\\\\Boot\\\\BOOTX64.EFI\n\n```\nload_env default\n\nfunction load_video {\n  insmod efi_gop\n  insmod efi_uga\n  insmod video_bochs\n  insmod video_cirrus\n  insmod all_video\n}\n\nload_video\nset gfxpayload\u003dkeep\n\ninsmod gzio\ninsmod part_gpt\n\nset timeout\u003d4\n\nmenuentry \"Windows 10 UEFI\" {\nset default\u003d$1\nsave_env default\ninsmod chain\nsearch --file --no-floppy --set\u003droot /efi/Microsoft/win10/bootmgfw.efi\nchainloader (${root})/efi/Microsoft/win10/bootmgfw.efi\n}\n```\n\nAfter install windows 10 for example move the boot folder to win10\n\nHowever I would like to assume that there is no BCD file, as this may be on a fresh machine.\n\nI am trying to create the \\\\EFI\\\\Microsoft\\\\Boot\\\\BCD file to point at my shim.efi or bootx64.efi fallback loader, from a windows PE environment with no pre-existing BCD file, which is proving difficult. Because I am not good with the command line + the commands used don\u0027t seem to work, I have also attempted to use BOOTICE to generate the BCD file as such, however when booting it gets a 7b error. Will soldier on!\n\n[![55my2j8ddd6y93vynt33_thumb.jpg](http://www.dumpt.com/img/files/55my2j8ddd6y93vynt33_thumb.jpg)](http://www.dumpt.com/img/viewer.php?file\u003d55my2j8ddd6y93vynt33.jpg \"External link\")\n\n[![tuk606j3p4z2jct6m750_thumb.jpg](http://www.dumpt.com/img/files/tuk606j3p4z2jct6m750_thumb.jpg)](http://www.dumpt.com/img/viewer.php?file\u003dtuk606j3p4z2jct6m750.jpg \"External link\")\n\n"
    },
    {
      "id": "204370",
      "timestamp": "2017-08-07T20:24:21+00:00",
      "author": "cdob",
      "content": "\u003e windows 10, is the culprit, it likes to ~~break~~ repair the EFI system after an update.\nYes, windows update replaces \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi, but not \\\\EFI\\\\Boot\\\\bootx64.efi. No idead about a upgrade currently.  \nIn my opinion Windows may write to \\\\EFI\\\\Microsoft\\\\. That\u0027s the operation system efi folder.  \n\nThe hardware is broken: prefering \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi creates a windows only machine for average end user. The clean solution would be to change the UEFI implementation, to be done by the hardware manufacturer.  \nYes, it\u0027s simpler to change the OS part.  \n\n\u003cbr /\u003e\n\n[https://h30434.www3....tu/td-p/2503733](https://h30434.www3.hp.com/t5/Notebooks-Archive-Read-Only/Changing-Boot-Order-on-Dual-Boot-Windows-8-and-Ubuntu/td-p/2503733 \"External link\")  \n\u003e There is some sort of a \"recovery feature\" or so that on every boot sets the very first UEFI load option to point to one of the two locations, in this order:  \n\u003e \\\\EFI\\\\Microsoft\\\\Boot\\\\bootmgfw.efi  \n\u003e \\\\EFI\\\\Boot\\\\bootx64.efi  \n\u003e\n\u003e This option is displayed as \"OS boot Manager\" (for the first path) and something akin to \"UEFI partition\" for the second path, completely ignoring the actual name given to it (when you look at the EFI variables through efibootmgr, you can see that what is displayed as \"OS boot Manager\" actually is set to the name \"Windows Boot Manager\"; why anyone would do such renaming is beyond me).\n\n\u003cbr /\u003e\n\n\u003e BCD file to point at my shim.ef\nbootmgfw.efi dosn\u0027t chainload another efi boot loader.  \nIt may load another efi apllication.  \n\n\u003cbr /\u003e\n\n\u003cbr /\u003e\n\nDo you use Windows 10 pro?  \nTry a shutdwon script.  \n\nGiven a file \\\\efi\\\\boot\\\\shim.efi  \n\nTesting, brute force windows UEFI:  \nmountvol.exe s: /s  \nbcdboot c:\\\\windows /s s: /F UEFI  \nUEFI boots Windows by default.  \n\nmountvol.exe s: /s  \nS:\\\\EFI\\\\Microsoft\\\\Boot\\\u003ecopy bootmgfw.efi bootwin.efi  \n\nmenuentry \"UEFI: Windows /EFI/Microsoft/Boot/bootwin.efi\" {  \nchainloader /EFI/Microsoft/Boot/bootwin.efi  \n}  \n\n\u003cbr /\u003e\n\nSet a shutdown script at Group Policy Editor gpedit.msc:  \n\ncd /d C:\\\\Windows\\\\System32\\\\GroupPolicy\\\\Machine\\\\Scripts\\\\Shutdown  \nnotepad grub.cmd  \n\n```\n%SystemRoot%\\system32\\mountvol.exe s: /s\n(echo. \u0026echo %date% %time%) \u003e\u003e bootmgfw.log\ndir s:\\EFI\\Microsoft\\Boot\\bootmgfw.efi \u003e\u003e bootmgfw.log\ncd /d S:\\EFI\\Microsoft\\Boot\ncopy \\efi\\boot\\shim.efi bootmgfw.efi /y\n%SystemRoot%\\system32\\mountvol.exe s: /d\n```\n\n.  \nNo windows update in between: At next UEFI boot, grub is loaded.  \n\nMay be add this at shut up too.  \nIf there is a windows update interference, next boot goes to windows.  \nA second boot should give grub back.   \n"
    }
  ]
}