{
  "id": "21667",
  "title": "More USB 3 fun",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "205350",
      "timestamp": "2018-01-03T08:27:36+00:00",
      "author": "kelsie",
      "content": "I\u0027m trying to boot win7 from a vhd on a stick. It has been working fine but on the more recent computers, say two years old or less, it gets bsoded.\n\nI\u0027ve read here about the pains people went through with usb 3 so I suspected that might be the issue. Since I\u0027m trying to boot on hp computers I have installed some usb3 hp drivers. I\u0027ve also made the two changes in the registry for each of the relevant services. But to no avail.\n\nWhat might I be missing here?\n\nThese computers have windows 7 as their os. If I try to boot winpe7 it boots fine but the keyboard and mouse, which are connected by usb, don\u0027t work. If I try to boot winpe10 it also boots fine but everything works as it should, including access to the files in the stick.\n\n**Edited by kelsie, 03 January 2018 - 08:32 AM.**\n"
    },
    {
      "id": "205354",
      "timestamp": "2018-01-03T14:55:58+00:00",
      "author": "Wonko the Sane",
      "content": "Well, if you don\u0027t specify which services you installed and what registry changes you made it is hard to say what you missed.\n\nAlso \"how\" you \"installed\" them might make a difference, really difficult to say.\n\nDid you edit an already built PE? (modifying the boot.wim, or is it a \"flat\" build?)\n\nDid you try adding the drivers as a .script or similar in the build?\n\nEtc., etc., the more details you provide the more likely is that someone could spot a mistake or a missing step...\n\nThe last version by cdob for Winbuilder projects, which is attached here:\n\n[http://reboot.pro/to...ssues/?p\u003d189313](http://reboot.pro/topic/16769-usb3-issues/?p\u003d189313 \"\")\n\ncontains some references to discussion topics (references that were cleverly obliterated in more recent releases editing the history in an attempt to remove any traces of the past ![:w00t:](http://reboot.pro/public/style_emoticons/default/w00t.gif) ![:ph34r:](http://reboot.pro/public/style_emoticons/default/scared9.gif)).\n\nBefore:\n\u003e\n\u003e HistoryNotes\u003dto process faster required files attached  \n\u003e HistoryNotes\u003dcdob main page (post 6) [http://www.911cd.net...showtopic\u003d23637](http://www.911cd.net/forums//index.php?showtopic\u003d23637 \"External link\")- also cdob pe2/3 notes post 173 [http://reboot.pro/10...443#entry115443](http://reboot.pro/10126/page__st__165__p__115443#entry115443 \"\")   \n\u003e HistoryNotes\u003dMore Info in USB3 Issues thread \u003chttp://reboot.pro/16769/\u003eparticularly cdobs post \"76   \n\u003e HistoryNotesPE1\u003dFor Gena script requires usb mass storage support ComboRemovableDevices.script--\\\u003e Enable:\"Add Usb Mass Storage Support\" \u003d\u003d\\\u003e Tested \\\u0026 Confirmed by BobxT (Thanks)  \n\u003e HistoryNotes\u003dThe Intel USB 3.0 eXtensible Host Controller Driver is not supported in Windows XP or Windows Vista  \n\u003e History001\u003dScript by Lancelot ported from plugin of Driver Master cdob :wink: for Gena Project  \n\u003e History002\u003dLancelot support to pe2/3 projects (JFX codes used to add driver)  \n\u003e History005\u003dArvy Download_Level\u003d1  \n\u003e History006\u003dLancelot IniVariables OS  \n\u003e History007\u003dChrisR - Supports drivers for hardware manufacturers AMD, Intel, Renesas2 and Renesas3 Drivers following \u0027USB3 Issues\u0027 topic (\u003chttp://reboot.pro/16769/\u003e), thanks cdob, darren rose, MedEvil   \n\u003e History008\u003dChrisR - separate process for PE2/3, complete PE1 process following cdob\u0027s indications, Driver versions for future updates.  \n\u003e History009\u003dChrisR - No process for PE1 (different process) which already has its own script \"RemovableDeviceUSB3 More\" in Gena but kept for history or future merger.  \n\u003e History009\u003dChrisR - Adds Asmedia, Etron, Fresco Logic, Texas Instruments, Via Drivers.  \n\u003e History010\u003dcdob - PE3 native USB boot, flat file USB boot  \n\u003e History012\u003dLancelot - NoWarnROW implemented  \n\u003e History013\u003dChrisR - Following AU3381 updated  \n\u003e History015\u003dChrisR - WimGapi Work Dir  \n\u003e History016\u003dChrisR - copy dism.exe.mui with en-US fallback  \n\u003e History017\u003died206 - Added drivers for Intel Haswell\u0027s chipsets (Intel 4th Gen Core)  \n\u003e History018\u003died206 - Supporting Flat Boot from USB 3.0 in Intel Haswell Chipsets  \n\u003e History019\u003dcdob - rework Intel USB 3.0, removed embedded wdfldr at VIA and Fresco driver, dism dosn\u0027t include this part anyway  \n\u003e History019\u003dcdob - Intel USB 3.0 Switch driver added, combined mode adjusted  \n\u003e History020\u003dcdob - Intel USB 3.0 Switch driver added, combined mode Series 8 drivers at Series 7 hardware  \n\u003e History021\u003dcdob - Intel USB 3.0 Version 3.0.0.19 Driver for Intel NUC - testing  \n\u003e History022\u003dcdob - Intel USB 3.0 Version 3.0.1.41 Driver for Intel Series 8/9 - testing  \n\u003e History023\u003dcdob - enable Intel switch driver at Native mode  \n\u003e History024a01\u003dcdob - timing games\n\nAfter:\n\u003e\n\u003e HistoryNotes01\u003dto process faster required files attached  \n\u003e HistoryNotes02\u003dPE1 For Gena plugin requires usb mass storage support ComboRemovableDevices.script--\\\u003e Enable:\"Add Usb Mass Storage Support\" \u003d\u003d\\\u003e Tested \\\u0026 Confirmed by BobxT (Thanks)  \n\u003e HistoryNotes\u003dThe Intel USB 3.0 eXtensible Host Controller Driver is not supported in Windows XP or Windows Vista  \n\u003e History001\u003dPlugin by Lancelot ported from plugin of Driver Master cdob :wink: for Gena Project  \n\u003e History002\u003dLancelot support to pe2/3 projects (JFX codes used to add driver)  \n\u003e History005\u003dArvy Download_Level\u003d1  \n\u003e History006\u003dLancelot IniVariables OS  \n\u003e History007\u003dChrisR - Supports drivers for hardware manufacturers AMD, Intel, Renesas2 and Renesas3 Drivers following \u0027USB3 Issues\u0027 , thanks cdob, darren rose, MedEvil  \n\u003e History008\u003dChrisR - separate process for PE2/3, complete PE1 process following cdob\u0027s indications, Driver versions for future updates.  \n\u003e History009\u003dChrisR - No process for PE1 (different process) which already has its own Plugin \"RemovableDeviceUSB3 More\" in Gena but kept for history or future merger.  \n\u003e History009\u003dChrisR - Adds Asmedia, Etron, Fresco Logic, Texas Instruments, Via Drivers.  \n\u003e History010\u003dcdob - PE3 native USB boot, flat file USB boot  \n\u003e History012\u003dLancelot - NoWarnROW implemented  \n\u003e History013\u003dChrisR - Following AU3381 updated  \n\u003e History015\u003dChrisR - WimGapi Work Dir  \n\u003e History016\u003dChrisR - copy dism.exe.mui with en-US fallback  \n\u003e History017\u003died206 - Added drivers for Intel Haswell\u0027s chipsets (Intel 4th Gen Core)  \n\u003e History018\u003died206 - Supporting Flat Boot from USB 3.0 in Intel Haswell Chipsets  \n\u003e History019\u003dcdob - rework Intel USB 3.0, removed embedded wdfldr at VIA and Fresco driver, dism dosn\u0027t include this part anyway  \n\u003e History020\u003dcdob - Intel USB 3.0 Switch driver added, combined mode Series 8 drivers at Series 7 hardware - Date\u003d2014.04.19  \n\u003e History022\u003dLancelot syntax updated  \n\u003e History023\u003dLancelot updated v023 - Date\u003d2016.01.28  \n\u003e History024\u003dLancelot Deprecate old syntax (PEBakery Support) - Date:2017.12.07\n\nOnly to show how difficult it is to effectively delete data to negate the past. :wink:\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "205359",
      "timestamp": "2018-01-04T01:43:33+00:00",
      "author": "kelsie",
      "content": "What I did was boot the stick vhd as usual on an HP computer, go to device manager, right click on the devices, update drivers. Did this for \u0027Intel® USB 3.0 eXtensible Host Controller\u0027 and \u0027Intel® USB 3.0 Root Hub\u0027. Then went to the registry and changed values in the keys iusb3hub and iusb3xhc located at HKLM\\\\SYSTEM\\\\CurrentControlSet\\\\services. For both of them changed the value of \u0027Start\u0027 to 0 and of Group to \u0027Boot Bus Extender\u0027. Shut down computer and then tried to boot on the newer HP computer. Bsod.\n\nThe winpe\u0027s I loaded to experiment were taken from the installation media, with no changes.\n\n**Edited by kelsie, 04 January 2018 - 01:47 AM.**\n"
    },
    {
      "id": "205360",
      "timestamp": "2018-01-04T05:34:27+00:00",
      "author": "cdob",
      "content": "Does exist only one HP computer? Which one do you use?  \nWhich USB 3.0 driver version do you use?  \nWhich USB 3.0 BIOS settigs do you use?  \nWhat about a USB 3.0 switch driver?  \n\nIntegrate current USB 3.0 drivers to winpe7.   \n"
    },
    {
      "id": "205388",
      "timestamp": "2018-01-05T05:54:49+00:00",
      "author": "kelsie",
      "content": "I\u0027ve looked at the drivers I installed on the vhd, they are iusb3hub.sys and iusb3xhc.sys and both are version 2.5.0.19 with the description I posted above. Are you saying I can try to use the drivers that work OK on the winpe10 or the installed win7 and switch the ones in the vhd? That\u0027s a good idea. How can I go about doing that? I\u0027ve searched the wimpe10 registry and one possibly relevant key I found was at HKLM\\\\ControlSet001\\\\Services\\\\USBHUB3 with the driver being UsbHub3.sys for which the file description is \u0027USB3 HUB Driver\u0027 and version 10.0.10586.122   \n"
    },
    {
      "id": "205412",
      "timestamp": "2018-01-05T17:14:15+00:00",
      "author": "cdob",
      "content": "No, don\u0027t use Window 10 USB drivers at Windows 7. This will fail.  \n\nFernando maintains a driver collection.  \nThe drivers are tested at different hardware.  \n[https://www.win-raid...and-modded.html](https://www.win-raid.com/t834f25-USB-Drivers-original-and-modded.html \"External link\")  \n\nThere are USB 3 drivers for Intel 7-Series Chipsets  \nAnd other drivers for Chipsets from 8-Series up.  \n2.5.0.19 relates to a 8-Series chipset.  \n\nAgain, which hardware do you use?  \nWhich HP do you use? Name the model.  \nCan you name the USB controller HardareID from the device manager?  \n\nThere is a driver iusb3hcs.sys \"Intel® USB 3.0 Host Controller Switch Driver\".  \nDepending on BIOS settings this driver is required too. Set start\u003d0 too.  \n\nOr try native early boot drivers.  \n[http://reboot.pro/to...p1/#entry127772](http://reboot.pro/topic/14186-usb-hdd-boot-and-windows-7-sp1/#entry127772 \"\")  \nSet BootFlags\u003d0x4 to services iusb3hcs, iusb3xhc, iusb3hub in addition.  \n\nTry from scratch:  \nApply a Windows 7 install.wim to the VHD.  \nRun Dism Add-Driver to include the Intel USB 3.0 drivers.  \nFix USB boot settings next.   \n"
    },
    {
      "id": "205632",
      "timestamp": "2018-01-15T22:19:08+00:00",
      "author": "kelsie",
      "content": "I\u0027ve used Dism to add the drivers but I\u0027m stuck at preparing the registry because either I didn\u0027t use it properly or it does not write to the registry. I\u0027ve searched the documentation for dism and also pnputil and also the command line \u0027RUNDLL32.EXE SETUPAPI.DLL,...\u0027 and it seems all of them add the drivers to the driver store but the registry is only written after the drivers are loaded for the first time making this a catch22 situation. I used \u0027Dism /Image:C:\\\\test\\\\offline /Add-Driver /Driver:C:\\\\drivers\\\\mydriver.inf\u0027. Is this right? I got the hardwareID for the computer usb3 (hp optiplex 7040), it\u0027s IUSB3\\\\ROOT_HUB30\\\u0026VID_8086\\\u0026PID_A12F\\\u0026REV_0031\\\u0026SID_06B91028. A google search pointed to [https://downloadcent...el-NUC-Products](https://downloadcenter.intel.com/download/24503/Intel-USB-3-0-Device-Driver-for-Intel-NUC-Products \"External link\")which has the driver \u0027Intel® USB 3.0 Device Driver for Intel® NUC Products\u0027 Version: 3.0.5.69. I\u0027ll try with this one.   \n"
    },
    {
      "id": "205651",
      "timestamp": "2018-01-16T21:42:44+00:00",
      "author": "cdob",
      "content": "\u003e I got the hardwareID for the computer usb3 (hp optiplex 7040), it\u0027s IUSB3\\\\ROOT_HUB30\\\u0026VID_8086\\\u0026PID_A12F\\\u0026REV_0031\\\u0026SID_06B91028.\nThis is the HUB HardwareID, the USB Controller HardwareID would be nice too.  \n\nOptiplex reminds to Dell. And this to terrible USB BIOS behaviour.  \nDo you use a HP or a Dell Optiplex 7040?  \n\n[http://www.dell.com/.../drivers?lwp\u003drt](http://www.dell.com/support/home/us/en/04/product-support/product/optiplex-7040-desktop/drivers?lwp\u003drt \"External link\")  \n[https://downloads.de....0.3.42_A02.EXE](https://downloads.dell.com/FOLDER04286819M/1/Intel-USB-eXtensible-Host-Controller-Driver_4H5XG_WIN_5.0.3.42_A02.EXE \"External link\")  \n\nExpand Intel-USB-eXtensible-Host-Controller-Driver_4H5XG_WIN_5.0.3.42_A02.EXE at 7-zip.  \n\n\u003cbr /\u003e\n\n\u003cbr /\u003e\n\nGiven a USB stick D:  \n\n```\nmd D:\\VHD\ndiskpart.exe\nlist disk\nlist vol\ncreate vdisk file\u003dD:\\VHD\\win7.vhd maximum\u003d16384 type\u003dfixed\nselect vdisk file\u003dD:\\VHD\\win7.vhd\nattach vdisk\nlist disk\ncreate partition primary\nformat fs\u003dntfs quick\nassign letter\u003dV\nlist vol\n\nDism.exe /Apply-Image /ImageFile:E\\sources\\install.wim /Index:4 /ApplyDir:V:\\\nbcdboot.exe V:\\Windows /s D:\n\nDism.exe /image:V:\\ /Add-Driver /driver:\"C:\\drivers\\Win7_x64\\USB3\" /recurse /ForceUnsigned\nDism.exe /image:V:\\ /Get-Drivers /Format:Table\n```\n\n\u003cbr /\u003e\n\nThere is attached a file fix_USB3_SD.zip  \n[http://www.msfn.org/...comment\u003d1125092](http://www.msfn.org/board/topic/175652-desperate-to-installuse-windows-7-help/?do\u003dfindComment\u0026comment\u003d1125092 \"External link\")  \n\nEnable USB boot including Intel USB 3.0 driver.  \n\n```\nfix_USB3_SD.cmd V:\\Windows\n\n\ndiskpart.exe\nselect vdisk file\u003dD:\\VHD\\win7.vhd\ndetach vdisk\n```\n\n\u003cbr /\u003e\n\n"
    }
  ]
}