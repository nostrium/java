{
  "id": "21899",
  "title": "Multiboot usb won\u0027t boot after partition resizing",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "208445",
      "timestamp": "2018-12-04T10:06:26+00:00",
      "author": "Peter80",
      "content": "I have multiboot usb created with YUMI and i used GParted Live to resize the partition on the usb, shrinking its size, but after that the usb won\u0027t boot. My guess is that the partition table is somehow damaged during the partition resizing operation, and i didn\u0027t backup the partition table before using GParted.  \nIs there a way to fix the partition table on the usb? Maybe using diskpart, because my laptop has Windows 7, but i also could use other software or live cd, just don\u0027t know which.\n\n"
    },
    {
      "id": "208446",
      "timestamp": "2018-12-04T11:07:05+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e I have multiboot usb created with YUMI and i used GParted Live to resize the partition on the usb, shrinking its size, but after that the usb won\u0027t boot. My guess is that the partition table is somehow damaged during the partition resizing operation, and i didn\u0027t backup the partition table before using GParted.  \n\u003e Is there a way to fix the partition table on the usb? Maybe using diskpart, because my laptop has Windows 7, but i also could use other software or live cd, just don\u0027t know which.\n\nI am not familiar with YUMI, AFAICR it uses syslnux \"under the hood\" as \"main\" bootmanager.\n\nSo what may have happened is that the ldlinux.sys has \"wrong\" information ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif)\n\nUsually it is not an issue to just re-install syslinux:\n\n[https://www.syslinux...p?title\u003dInstall](https://www.syslinux.org/wiki/index.php?title\u003dInstall \"External link\")\n\nbut it has to be sen which exact version of syslinux is used and possibly Yumi is using \"non-standard\" directory structure, so it would be better to repair the Yumi, it has to be seen as well which exact version your Yumi USB is (was) running, see here:\n\n[https://www.pendrive...ot-usb-creator/](https://www.pendrivelinux.com/yumi-multiboot-usb-creator/ \"External link\")\n\n-\\\u003eFAQ:\n\u003e\n\u003e How to force a rebuild of the Syslinux MBR:  \n\u003e\n\u003e This is useful if your YUMI prepared USB drive is somehow no longer bootable.  \n\u003e\n\u003e For Newest version of YUMI:  \n\u003e From the multiboot folder on your flash drive, delete the hidden file ldlinux.sys and then rename the libcom32.c32 file to _libcom32.c32. Then use YUMI to install any menu item. YUMI will notice that the file is missing and will attempt to reinstall syslinux and repair the master boot record. Once finished, rename _libcom32.c32 back to libcom32.c32.  \n\u003e\n\u003e For Older versions of YUMI:  \n\u003e Delete the hidden ldlinux.sys file from the multiboot folder, and use YUMI to install any menu item. YUMI will notice that this file is missing and will attempt to repair it.\n\nSomeone must tell the good guy over there how \"older\" and \"newest\" are pointless adjectives when talking of programs, particularly if the program (rightly) uses versions, such as the current YUMI-2.0.6.1a.exe, in any case, if you can find on the USB the file libcom32.c32 it is the \"newest\", otherwise it is the \"older\".\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "208447",
      "timestamp": "2018-12-04T11:55:16+00:00",
      "author": "Peter80",
      "content": "I don\u0027t think i can repair syslinux because i can\u0027t access the drive. Windows recognizes the drive, assigns a drive letter, but if i try to open it shows that i need to format the drive before using it.  \nThe last YUMI version i used to add iso file to the drive was 2.0.6.0\n\nThough in disk management Windows recognizes the partition but show the file system as RAW and not as fat32. I probably should have used Windows to resize the partition instead of gparted:\n\n![zTWKMdd.png](https://i.imgur.com/zTWKMdd.png)\n\n**Edited by Peter80, 04 December 2018 - 12:03 PM.**\n"
    },
    {
      "id": "208448",
      "timestamp": "2018-12-04T12:30:35+00:00",
      "author": "Peter80",
      "content": "I installed MiniTool Partition Wizard and it recognize the usb drive as fat32 file system which is strange:  \n![y8p27cA.png](https://i.imgur.com/y8p27cA.png)  \n\nAnd also, i can explore the content of the drive from inside the program, but can\u0027t edit the files:  \n![VXPkRoo.png](https://i.imgur.com/VXPkRoo.png)\n\n"
    },
    {
      "id": "208449",
      "timestamp": "2018-12-04T12:58:43+00:00",
      "author": "Wonko the Sane",
      "content": "Well, then we need to first recover the volume/partition and only later the ldlinux will be needed to be fixed.\n\nUnfortunately partition wizard (while generally being a good tool) has not the \"level of detail\" needed to analyze the issue.\n\nCan you make a backup of both the MBR and of the PBR?\n\nIdeally you could use a hex/disk editor to save a copy of these two sectors.\n\nOr, are you familiar with command line tools? dsfo/dsfi part of the dsfok toolkit are generally recommended by me:\n\n[http://members.ozema...ware/index.html](http://members.ozemail.com.au/~nulifetv/freezip/freeware/index.html \"External link\")\n\nI need a copy of the MBR (first absolute sector or LBA0) and of the PBR (either sector LBA 63 if partitoned under up to XP or LBA 2048 if under Vista or later, do both as it costs nothing).\n\nThat would be:\n\ndsfo \\\\\\\\.\\\\PhysicalDrive4 0 512 C:\\\\myfailed.mbr\n\ndsfo \\\\\\\\.\\\\PhysicalDrive4 32256 512 C:\\\\myfailedxp.pbr\n\ndsfo \\\\\\\\.\\\\PhysicalDrive4 1048576 512 C:\\\\myfailed7.pbr\n\nOnce you have the files, zip them together in an archive and either attach it to your next post or upload them to a free file hosting site and post a link to the archive.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "208451",
      "timestamp": "2018-12-04T13:42:54+00:00",
      "author": "Peter80",
      "content": "I haven\u0027t used these command line tools so far. How to list the drives with dsfo? I want to see how it list my usb drive.  \n\nI am reading some guides about using testdisk to recover partition tables. Is testdisk a good tool for recovering partition tables?\n\n"
    },
    {
      "id": "208452",
      "timestamp": "2018-12-04T14:06:52+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e I haven\u0027t used these command line tools so far. How to list the drives with dsfo? I want to see how it list my usb drive.es?\nYou don\u0027t list them.  \nYou check the disk number in diskpart (or in partition wizard) and use that disk number as \\\\\\\\.\\\\Physicaldrive# (in the screenshot you posted the disk was #3 in diskpart and #4 in partition wizard, probably because you added another USB).  \n\n\u003e I am reading some guides about using testdisk to recover partition tables. Is testdisk a good tool for recovering partition tables?\nTestdisk is an exceptionally good tool to recover partition tables, but it remains a tool, very likely it can solve the issue, if properly used.  \n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)  \nWonko   \n"
    },
    {
      "id": "208453",
      "timestamp": "2018-12-04T14:51:45+00:00",
      "author": "Peter80",
      "content": "Here are the files from the dsfo tool: [link](https://mega.nz/#!ZmISlCBb!nVxqH-32t9HExi_U6EixKgutelMSmC2ovnwOse9xMCI \"External link\")\n\n"
    },
    {
      "id": "208454",
      "timestamp": "2018-12-04T16:47:08+00:00",
      "author": "Wonko the Sane",
      "content": "Ok, here is the data \"as is\":\n\n```\n\n\n\n\n\nMBR:\nEntry\tType\tBoot\tbCyl\tbHead\tbSect\teCyl\teHead\teSec\tStartSector\tNumSectors\n#0\t0B\t80\t0\t1\t1\t930\t27\t57\t63\t\t14942145\t\n#1\t21\t00\t979\t0\t1\t979\t0\t63\t15727635\t63\t\n#2\t00\t00\t0\t0\t0\t0\t0\t0\t0\t\t0\t\n#3\t00\t00\t500\t34\t39\t571\t221\t50\t8034680\t\t115240\n\t\n\nPBR (the drive was partitioned under XP or earlier, in any case it is a \"63 sectors before\":\n3      0003    OEM String:                  MSWIN4.1                \n11     000B    Bytes per sector:     0200   512\n13     000D    Sectors per cluster:    08   8\n14     000E    Reserved sectors:     002C   44\n16     0010    Number of FAT(s):       02   2\n17     0011    Max ROOT entries:     0000   0\n19     0013    Small type sectors:   0000   0\n21     0015    Media type:             F8   248\n22     0016    Secs per FAT (small): 0000   0\n24     0018    Sectors per Head:     003F   63\n26     001A    Number of Heads:      00FF   255\n28     001C    Sectors Before:   0000003F   63\n32     0020    Large Sectors:    00E3FFC1   14942145\n36     0024    Sectors per FAT:  000038F2   14578\n40     0028    Flags:                0000   0\n66     0042    NT signature:           29   41\n77     004D    Volume Serial:    20202045   538976325\n```\n\nThe partition table in the MBR is \"strange\".\n\nThe partition of type 21 spanning over the last cylinder makes me think of a drive that has been used with RMPREPUSB/Easy2Boot.\n\nThe 4th partition entry (even if it has no partition ID) may be part of the problem or the actual problem, as it clearly overlaps the \"main\" partition in 1st entry.\n\nOtherwise the data seems OK, the data in 1st entry is compatible with the data in the PBR.\n\nWhile it is true that the partitioning is not respecting the \"standard\" of \"whole\" end cyl/sectors, nor the \"1 MB alignment\" Windows 7 should not have issues with that. ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif)\n\nI would try zeroing out the 4th entry and see if Windows recognizes the volume correctly, otherwise you will need (using Gparted or Mini Tool Partition Wizard) to resize it to a cyllinder boundary.\n\nTo 00 the 4 th entry you can use again a hex/disk editor, or - I am attaching the corrected MBR - deploy it with dsfi:\n\ndsfi \\\\\\\\.\\\\PhysicalDrive# 0 512 myfailed_00ed4th.mbr\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko  \n\n#### Attached Files {#attach_wrap}\n\n* [![Attached File](http://reboot.pro/public/style_extra/mime_types/zip.gif)](http://reboot.pro/index.php?s\u003d81d3fbbe9530a6237509364127bc7314\u0026app\u003dcore\u0026module\u003dattach\u0026section\u003dattach\u0026attach_id\u003d16236 \"Download attachment\") [**myfailed_00ed4th.zip**](http://reboot.pro/index.php?s\u003d81d3fbbe9530a6237509364127bc7314\u0026app\u003dcore\u0026module\u003dattach\u0026section\u003dattach\u0026attach_id\u003d16236 \"Download attachment\") **650bytes** 210 downloads\n\n"
    },
    {
      "id": "208455",
      "timestamp": "2018-12-04T17:53:15+00:00",
      "author": "Peter80",
      "content": "I deployed the new MBR file with dsfi tool, but Windows still do not recognize the usb drive.  \n\nI also tried testdisk but it didn\u0027t find any partitions for recovering.  \n\nI think i will just format the drive and use YUMI to recreate again the multiboot usb. Just have to remember the next time before doing experiments, to create backup image of the usb drive using clonezilla or similar tool.\n\n"
    },
    {
      "id": "208457",
      "timestamp": "2018-12-04T18:37:28+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e I deployed the new MBR file with dsfi tool, but Windows still do not recognize the usb drive.  \n\u003e\n\u003e I also tried testdisk but it didn\u0027t find any partitions for recovering.  \n\u003e\n\u003e I think i will just format the drive and use YUMI to recreate again the multiboot usb. Just have to remember the next time before doing experiments, to create backup image of the usb drive using clonezilla or similar tool.\n\nYep, the partition is there and is seemingly \"valid\", so testdisk finds nothing to worry about/to correct.\n\nIt remains the doubt on fractional cylinder/head, but I don\u0027t think that is the actual reason.\n\nCan it not be some kind of issue with the Registry and \"known\" volumes? Maybe changing the disk signature would \"reset\" something?\n\nCan you try resizing the partition with MiniTool Partition Wizard ?\n\nIt should be able to do that,.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "208464",
      "timestamp": "2018-12-04T21:16:20+00:00",
      "author": "Peter80",
      "content": "I resized the partition with MiniTool and the operation finished successfully, but Windows still does not recognize the usb drive.  \n\nBy the way, this is what testdisk shows when came to \u0027analyze\u0027 phase, but after this do not find any partitions to recover:  \n\n```\nDisk /dev/sdd - 8054 MB / 7681 MiB - CHS 1023 248 62\nCurrent partition structure:\n     Partition                  Start        End    Size in sectors\n\nInvalid FAT boot sector\n 1 * FAT32                    0   1  2   938  59 24   14426307\n 1 * FAT32                    0   1  2   938  59 24   14426307\n\nWarning: Bad ending sector (CHS and LBA don\u0027t match)\n 2 P Sys\u003d21                1022 215 34  1022 216 34         63\n\nWarning: Bad starting sector (CHS and LBA don\u0027t match)\n\n```\n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "208467",
      "timestamp": "2018-12-05T09:30:15+00:00",
      "author": "Wonko the Sane",
      "content": "Yes, but I meant resize to a cylinder boundary, I believe this can be done with the partition Wizard (but maybe I am confusing myself with some other program?)\n\nThe testdisk \"recognizes\" it with a \"queer\" geometry. H/S 248/62, \\*something\\* must be \"throwing it off\".\n\nThe device is surely 255/63.\n\nThe first partition (BTW you can simply delete the second one, it is a single cylinder type 21, as said the partition that RMPREPUSB can create) should start on 0/1/1 and end on n/254/63.\n\nI would need to see the MBR data after the resizing, but 0/1/2 on a 62 sectors geometry remains 0/1/1 on a 63 one (good), and in the same \"false\" geometry of 248/62 the 938/59/24 does actually make 14426307 sectors., so the testdisk report that CHS and LBA don\u0027t match is curious.\n\nI am starting to believe that the stick has some \"issues\" and reports incorrect data intermittently. ![:w00t:](http://reboot.pro/public/style_emoticons/default/w00t.gif) ![:ph34r:](http://reboot.pro/public/style_emoticons/default/scared9.gif)\n\nMaybe you should really format it and restart from scratch ![:(](http://reboot.pro/public/style_emoticons/default/sad.png).\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "208469",
      "timestamp": "2018-12-05T10:14:55+00:00",
      "author": "Peter80",
      "content": "I fixed it. I used the \u0027advanced\u0027 option in testdisk to repair FAT boot sector following this guide [https://www.cgsecuri...nced_FAT_Repair](https://www.cgsecurity.org/wiki/Advanced_FAT_Repair \"External link\"). After that Windows recognized the usb drive and i was able to make the drive bootable again following the instructions from YUMI faq page.   \nI don\u0027t think the problem was with the partition table. Also, it seems only Windows had issue with the drive, under linux it recognized the drive and i could mount it without problem. Probably that was caused by resizing the usb partition with gparted, instead using Windows, but i need to do more testing.\n\n"
    },
    {
      "id": "208470",
      "timestamp": "2018-12-05T11:35:29+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e Peter80, on 05 Dec 2018 - 11:14 AM, said:  \n\u003e\n\u003e I fixed it. I used the \u0027advanced\u0027 option in testdisk to repair FAT boot sector following this guide [https://www.cgsecuri...nced_FAT_Repair](https://www.cgsecurity.org/wiki/Advanced_FAT_Repair \"External link\"). After that Windows recognized the usb drive and i was able to make the drive bootable again following the instructions from YUMI faq page.  \n\u003e I don\u0027t think the problem was with the partition table. Also, it seems only Windows had issue with the drive, under linux it recognized the drive and i could mount it without problem. Probably that was caused by resizing the usb partition with gparted, instead using Windows, but i need to do more testing.\nGood. :smile:  \nPossibly something else (besides the filesystem data) triggered the mis-recognition by windows.  \nCan you chek it again in testdisk?  \nIt should see it as being 255/63.  \n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)  \nWonko  \n\nP.S. Now that you mentioned it I re-checked visually the \"myfailedxp.pbr\".  \n\nThe problem was definitely there, whilst the \"data\" was OK, the actual \"code\" was way off, there is in it (besides more \"binary crap\" instead of the booting code) a leading B80170.  \nVery likely that was the basic issue, we did some experiments some time ago:  \n[https://msfn.org/boa...\\\u0026comment\u003d987482](https://msfn.org/board/topic/152097-on-superfloppies-and-their-images/?do\u003dfindComment\u0026comment\u003d987482 \"External link\")  \n[https://msfn.org/boa...#comment-987482](https://msfn.org/board/topic/152097-on-superfloppies-and-their-images/?page\u003d9\u0026tab\u003dcomments#comment-987482 \"External link\")  \nthere must be a jmp short or jmp long instruction first thing, i.e. EBxx90 or E9xxxx for the filesystem to be recognized EVEN if it is not bootable r booted from.   \n"
    },
    {
      "id": "208471",
      "timestamp": "2018-12-05T12:00:09+00:00",
      "author": "Peter80",
      "content": "This is what testdisk is showing:\n\n![1CTnHZM.png](https://i.imgur.com/1CTnHZM.png)\n\n"
    },
    {
      "id": "208472",
      "timestamp": "2018-12-05T12:57:18+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e This is what testdisk is showing:\n\u003e\n\u003e ![1CTnHZM.png](https://i.imgur.com/1CTnHZM.png)\n\nYep, now the geometry is \"right\", though the previous testdisk output remains \"curious\".\n\nI updated my previous post, very likely I found the \"culprit\", I completely missed checking those few first bytes before.\n\nThe filesystem remains \"correct\" (and thus mini tool can see its contents) but Windows will find it as RAW.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "208475",
      "timestamp": "2018-12-05T13:57:50+00:00",
      "author": "Peter80",
      "content": "By the way, i can confirm that this issue is caused by gparted. I created two multiboot usb drives with YUMI, then booted from gparted live and resized the partitions of both usb drives. After that usb drives won\u0027t boot and Windows won\u0027t recognize them. So, i don\u0027t know why but gparted is causing this.\n\n"
    },
    {
      "id": "208476",
      "timestamp": "2018-12-05T14:26:37+00:00",
      "author": "@thehop",
      "content": "FYI + TOOLTIPP: DiskGenius is a good and detailed Windows + DOS Partitionmanger ...\n\n**Eassos DiskGenius** (earlier Partition Guru) © 2010 Eassos Co., Ltd. @ CHINA [https://www.diskgenius.com/aboutus.php](https://www.diskgenius.com/aboutus.php \"External link\")  \n\nDD: Oct 2018 - ca. 53 MB - Inno Setup Installer - Englisch - Freeware Version  \nOS: Windows XP - 10  \n\nHP: [https://www.diskgenius.com](https://www.diskgenius.com \"External link\")  \nPP: [https://www.diskgeni...om/editions.php](https://www.diskgenius.com/editions.php \"External link\")  \n\nSS: [http://www.snapfiles.../diskgenius.htm](http://www.snapfiles.com/screenshots/diskgenius.htm \"External link\")\n\n![dytb2x9ls6t2ggux9.png](http://666kb.com/i/dytb2x9ls6t2ggux9.png)\n\n**Edited by @thehop, 05 December 2018 - 02:28 PM.**\n"
    },
    {
      "id": "208480",
      "timestamp": "2018-12-05T14:55:05+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e By the way, i can confirm that this issue is caused by gparted. I created two multiboot usb drives with YUMI, then booted from gparted live and resized the partitions of both usb drives. After that usb drives won\u0027t boot and Windows won\u0027t recognize them. So, i don\u0027t know why but gparted is causing this.\n\nIf you still have one of those sticks you could try changing the first three bytes of the PBR to either EBxx90 or E9xxxx, and see if the Windows now can \"see\" them.\n\nIt is entirely possible that under Linux (like in FreeDOS) this \"peculiar\" check is not performed, so the good GParted guys didn\u0027t notice as the filesystem itself is correctly resized.\n\nAlso which version of GParted is it?\n\nSome time ago (probably years ago) I used GParted successfully, but cannot remender if I actually used it to resize a FAT32 partition. ![:unsure:](http://reboot.pro/public/style_emoticons/default/unsure.png) it is possible both that it is a new bug or that it has been there for years.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "208484",
      "timestamp": "2018-12-05T17:05:08+00:00",
      "author": "Peter80",
      "content": "I already formatted the usb drives, but i did another test. I setup one of the usb drive as multiboot using YUMI and then resized the partition on the drive using MiniTool Partition Wizard and this didn\u0027t cause any issues. The drive booted normally and Windows recognized it as it should be. So, i think in the future i will avoid using GParted for that kind of operations.\n\nI am using the current gparted version 0.32.0\n\n**Edited by Peter80, 05 December 2018 - 05:26 PM.**\n"
    }
  ]
}