{
  "id": "22363",
  "title": "Boot WTFPlay from VHD",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "216121",
      "timestamp": "2020-09-13T11:07:39+00:00",
      "author": "samotc",
      "content": "Hello everyone.  \nI have been using WTFPLAY for several years, I think it is a great player, perhaps the best, although the Bughead with Windows Server Core loaded in RAM in some things I like better.  \nI have tried F2k, JRMC, and HQPlayer 4 and find them light years away from either of these 2.  \nAs I find it uncomfortable to boot usb_pen from bios + f12 every time I want to start wtfplay, I have managed to add it to the windows boot menu by giving an entry, from it, to grub4dos and it starts perfectly and also saves the settings and playlist.  \nThe problem arises when I want to do this same with wtfplay in vhd. Here I get it to boot in multiple ways, but it doesn\u0027t save the settings or the playlist.  \nThe vhd I have created with winimage; in grub4dos I map it as (hd2)  \nand I set root to (hd2,1), which is exactly how I do it when booting from usb. Chainloader I put it as (0x82) +1 in both ways (USB and VHD) and I start it with the command  \n\"boot /efi/boot/bootx64.efi\" or \"boot /uefiboot.img\".  \nOf the 2 ways it boots, both in USB and in VHD, but in \"VHD mode\" DOES NOT SAVE THE CONFIGURATIONS.  \nWhat am I doing wrong?  \nIs there a way to \"trick\" WTFPlay into thinking that it is booting from the USB pen?  \nIf anyone has any ideas I will be very grateful  \nBest regards, enjoy the music.\n[![report.gif](https://files.diyaudio.com/forums/images/diy/buttons/report.gif \"Report Post\")](https://www.diyaudio.com/forums/report.php?p\u003d6333353 \"External link\")   \n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "216122",
      "timestamp": "2020-09-13T12:48:21+00:00",
      "author": "Wonko the Sane",
      "content": "I have not even the faintest idea of what you are talking about, what is this \"WTFPLAY\"?\n\nDo you have a link to its homesite?\n\nIs it this one?\n\n[http://wtfplay-project.org/](http://wtfplay-project.org/ \"External link\")\n\nPost the menu.lst you are using to boot from the USB and the one you are using for the VHD.\n\nIn gru4dos the target of the chainloader command is normally a volume (i.e. something like (hd0,0) ) or a MBR (i.e. something like (hd0)) or an OS loader (i.e. something like (hd0,0)/bootmgr) and the boot command is:\n\n1) self standing (no parameters)  \n2) only needed on command line as it is implied as last command in a menu.lst entry\n\nBesides, grub4dos only works in BIOS (not in UEFI) so how can you boot an EFI loader?\n\nSo I wonder about your report, maybe you are using some derivative of grub4dos or using it together with some other loader/softeare? ![:unsure:](https://reboot.pro/public/style_emoticons/default/unsure.png)\n\n![:duff:](https://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "216124",
      "timestamp": "2020-09-13T16:26:43+00:00",
      "author": "samotc",
      "content": "Thanks for the quick reply.  \nSure enough, that\u0027s the link  \nWTFPlay is a Linux audio player that loads from a usb pen and runs on RAM, which makes the sound quality very good.  \nThe USB pen contains 3 partitions,  \n1) ISO 9660 (linux files; vmlinuz.043, initrd2, uefiboot.img, etc ...)  \n2) FAT12 (/EFI/BOOT/bootx64.efi)  \n3) Ext2 (configuration files)  \nThe VHD contains the same 3 partitions as the usb pen  \nMenu.lst to boot from USB pen:  \nroot (hd2,1)  \nchainloader (0x82) +512  \nboot /efi/boot/bootx64.efi  \nMenu.lst to boot from VHD:  \nfind --set-root /wtf074.vhd  \nmap --heads \u003d 255 --sectors-per-track \u003d 63 /wtf074.vhd (hd2)  \nmap --hook  \nroot (hd2,1)  \nchainloader (0x82) +512  \n(also works (hd2)+512)  \nboot /efi/boot/bootx64.efi  \n(also works \"boot /uefiboot.img)  \nThe grub4dos is invoked from the windows 10 bootloader, but my computer is BIOS, not UEFI.  \nThe problem is that booting from vhd, I can\u0027t save the configurations or playlists in the configuration partition, but booting from USB yes.  \nThank you very much for your attention\n\n**Edited by samotc, 13 September 2020 - 04:33 PM.**\n"
    },
    {
      "id": "216126",
      "timestamp": "2020-09-13T17:55:07+00:00",
      "author": "Wonko the Sane",
      "content": "Well those are a mish-mash of settings (they work :smile: but not because they are correct ![:rolleyes:](https://reboot.pro/public/style_emoticons/default/rolleyes.gif) ).\n\nUsing DOS disk numbers (0x80), (0x81), (0x82), as you just demonstrated is possible, but since you anyway establish root to a volume (hd2,1) it makes more sense to use everywhere the same naming (hd0), (hd1), (hd2), etc.\n\nForget for one moment the menu.lst.\n\nWhen you see the entries, press c to get to command line.\n\nIn it (for the USB) type:\n\nroot (hd2,1)\n\nchainloader (hd2)0+512\n\nboot\n\nIt should boot normally.\n\nIf it does the entry in menu.lst is:\n\ntitle WTFPLAY on USB\n\nroot (hd2,1)\n\nchainloader (hd2)0+512\n\nSame goes for the .vhd, on command line this should work the same:\n\nfind --set-root /wtf074.vhd  \nmap --heads \u003d 255 --sectors-per-track \u003d 63 /wtf074.vhd (hd2)  \nmap --hook  \nroot (hd2,1)  \nchainloader (hd2)0+512  \nboot\n\nThe grub4dos boot command does not have parameters so, on command line you can have:  \nboot\n\nboot /efi/boot/bootx64.efi\n\nboot mickey mouse\n\nwith the same result.\n\nOn a menu.lst entry an implied \"boot\" command is executed before next \"title\" or before EOF.\n\nChainloading more than one sector is \"queer\", those entries should work just fine with chainloading just the MBR of the iso-hybrid image, i.e.:\n\nchainloader (hd2)0+1\n\nor\n\nchainloader (hd2)+1\n\nThere is no need to use winimage to make a .vhd, actually grub4dos interprets a \"static\" .vhd as a RAW image with an appended sector that is ignored.\n\nThe .iso, since it is a iso-hybrid is at the same time a .iso and a RAW image that grub4dos will understand just the same as the .vhd (as long as it is mapped to a \"hd-like\" virtual device, hd0-31 are hd-like hd32 up are CD-ROM like).\n\nWhat happens to you should be the following (the grub4dos settings you currently use to boot should be corrected for cleanness, but they are not involved) :\n\n1) when you boot from the USB stick (i.e. from the image directly dd-ed to the USB stick) you are booting from a \"real\" device, so the Linux system is entilrely loaded in RAM, then upon booting scan for real (hd-like) devices and the EXT2 partition (which very likely is identified by a label or by an UUID) is found, recognized and auto-mounted\n\n2) when you boot from the image (.vhd or RAW .iso) stored on the USB stick, you are mapping it to a \"virtual\" device, this device only exists in the grub4dos environment (unless you have particular provisions to pass this virtual device info to the Linux) so the OS is loaded in RAM, boots and scan for real devices, does not find the mapped image (which at this point is not available anymore) does not (cannot) mount the EXT2 volume and decides that it has nowhere to store settings.\n\nUsually it is a matter of passing a few parameters to the actual Linux kernel, but it depends greatly on what is included in the distro (in the initrd image) and which parameters it accepts, which scripts are autoexecuted at boot, etc. to find a way to run kpartx/losetup.\n\nRead this thread (seemingly unrelated):\n\n[http://reboot.pro/to...rom-vhd-how-to/](http://reboot.pro/topic/20603-linux-from-vhd-how-to/ \"\")\n\nfor an overview of the issue and generic (not necessarily good in this case) way to solve it.\n\nIn your case - since the Linux OS works already in RAM - you can probably get away with more simply running a script or a set of commands after having booted to mount the EXT2 partition, but it has to be seen.\n\nThe first thing you could check should be the differences in mounted devices in the booted Linux between when you boot from the USB stick and when you boot from the image.\n\n![:duff:](https://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "216127",
      "timestamp": "2020-09-13T20:51:34+00:00",
      "author": "samotc",
      "content": "Thank you very much for your help.  \nFirst of all, I will read carefully the threads that you recommend, as you will see, my grub4dos level is low, and linux even more scarce, but in this life with patience, everything can be learned.  \nThen I will try to put into practice what I learn in those threads and see if I get the desired results, if not, I will have learned something else.  \nThanks to this forum I know how little I know.\n\n"
    }
  ]
}