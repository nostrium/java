{
  "id": "21266",
  "title": "grub UEFI + wimboot - error: kernel too old.",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "200501",
      "timestamp": "2016-10-01T12:19:39+00:00",
      "author": "ndog37",
      "content": "Hi there  \n\nI am keen to know if anyone could get wimboot + grub UEFI pxe boot working.  \n\nHeres my steps  \n\ndownload Fedora-Xfce-Live-x86_64-24-1.2.iso  \nextract \\\\EFI\\\\BOOT\\\\  \n- BOOTX64.EFI  \n- grubx64.efi  \n- grub.cfg  \n\nsetup tftp to serve BOOTX64.EFI  \n\nAdd entries in grub.cfg  \n\nmenuentry \u0027wimboot 1\u0027 {  \nlinuxefi /boot/wimboot  \n}  \n\nmenuentry \u0027wimboot 2\u0027 {  \nlinuxefi /boot/wimboot  \ninitrdefi \\\\  \nnewc:bcd:/boot/boot/BCD \\\\  \nnewc:boot.sdi:/boot/boot/boot.sdi \\\\  \nnewc:boot.wim:/boot/boot.wim  \n}  \n\nAfter booting from UEFI pxe and selecting wimboot 1 or 2, there is an error message  \n\nerror: kernel too old.  \nerror: you need to load the kernel first.  \nPress any key to continue...\n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "200514",
      "timestamp": "2016-10-03T04:34:25+00:00",
      "author": "Areeb",
      "content": "Where is the Link to IPXE File in this case ?\n\n"
    },
    {
      "id": "200517",
      "timestamp": "2016-10-03T07:40:48+00:00",
      "author": "Wonko the Sane",
      "content": "Wimboot is seemingly not chainloadable in EFI mode ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif):  \n[http://forum.ipxe.or...ad.php?tid\u003d8112](http://forum.ipxe.org/showthread.php?tid\u003d8112 \"External link\")\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204066",
      "timestamp": "2017-07-08T12:20:00+00:00",
      "author": "steve6375",
      "content": "I managed to UEFI-boot from grub2 using wimboot by using iPXE as follows:\n\n1. Use a FAT32 partitioned disk (cannot be NTFS??) - I used a USB stick under VBox+VMUB (which will appear as a hard disk)\n\n\\\\ipxe.efi\n\n\\\\boot.ipxe\n\n\\\\wimboot\n\n\\\\win\\\\bcd\n\n\\\\win\\\\boot.sdi\n\n\\\\win\\\\boot.wim\n\n2. Boot to grub2 via UEFI\n\n3. run **chainloader /ipxe.efi** and then type **boot** - iPXE will run - press **Ctrl-B**\n\n**IMPORTANT: Wait for the *SECOND*Ctrl+B prompt before pressing Ctrl+B - if you press Ctrl+B on the first prompt the boot.ipxe script will give a \u0027Could not boot: No such device\u0027 error.**This was driving me crazy because a few times wimboot would work but most times it wouldn\u0027t because I was using the first Ctrl+B break point! It took me hours to figure out why it was only occasionally working!\n\n\\[Edit: adding ifopen to the boot.ipxe file fixes the issue of having to wait for the 2nd ctrl+B prompt! Apparently this process will only work if a NIC is present in the system\\]\n\n4. type **chain file:boot.ipxe**\n\nboot.ipxe contains:\n\n```\n#!ipxe\nifopen\ncpuid --ext 29 \u0026\u0026 set arch amd64 || set arch x86\nkernel file:/wimboot\ninitrd file:/win/bcd BCD\ninitrd file:/win/boot.sdi boot.sdi\ninitrd file:/win/boot.wim boot.wim\nboot\n```\n\nI [confirmed](https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/winpe-boot-in-uefi-or-legacy-bios-mode \"External link\") that WinPE was running in UEFI-mode.\n\nI am not sure it needs arch to be set, it seems to work without it.\n\nI haven\u0027t investigated if it is possible to automate it further yet. Just thought I would share as I was so pleased to finally work out why it was so temperamental!\n\n**Edited by steve6375, 18 March 2019 - 12:55 PM.**\n"
    },
    {
      "id": "204067",
      "timestamp": "2017-07-08T12:40:43+00:00",
      "author": "steve6375",
      "content": "An experimental download is attached.\n\nExtract to a FAT32 USB drive.\n\nAdd a \\\\win folder containing your winpe bcd + boot.sdi + boot.wim files\n\nYou can add **gui pause** after the wimboot filename to see what wimboot is loading and pause it before it boots.\n\n```\nkernel file:/wimboot gui pause\n```\n\nContinue discussion [here](http://reboot.pro/topic/20342-change-bcd-path-in-bootx64efi/ \"\")  \n\n#### Attached Thumbnails {#attach_wrap}\n\n* [![CaptureWimBoot.JPG](http://reboot.pro/uploads/monthly_07_2017/post-17818-0-48050500-1499517549_thumb.jpg)](http://reboot.pro/uploads/monthly_07_2017/post-17818-0-48050500-1499517549.jpg \"CaptureWimBoot.JPG - Size: 71.43KB\"){#ipb-attach-url-16031-0-95650500-1676066394}  \n\n#### Attached Files {#attach_wrap}\n\n* [![Attached File](http://reboot.pro/public/style_extra/mime_types/zip.gif)](http://reboot.pro/index.php?s\u003d4635b0ea47e767bf06fcdf9412135ed0\u0026app\u003dcore\u0026module\u003dattach\u0026section\u003dattach\u0026attach_id\u003d16030 \"Download attachment\") [**grub2-ipxe-wimboot-uefi.zip**](http://reboot.pro/index.php?s\u003d4635b0ea47e767bf06fcdf9412135ed0\u0026app\u003dcore\u0026module\u003dattach\u0026section\u003dattach\u0026attach_id\u003d16030 \"Download attachment\") **1.92MB** 941 downloads\n\n**Edited by steve6375, 08 July 2017 - 12:49 PM.**\n"
    },
    {
      "id": "204068",
      "timestamp": "2017-07-08T12:41:01+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e I managed to UEFI-boot from grub2 using wimboot by using iPXE as follows:\n\u003e\n\u003e ...\n\u003e\n\u003e I haven\u0027t investigated if it is possible to automate it further yet. Just thought I would share as I was so pleased to finally work out why it was so temperamental!\n\nAnd probably you wanted to post these news here:\n\n[http://reboot.pro/to...-in-bootx64efi/](http://reboot.pro/topic/20342-change-bcd-path-in-bootx64efi/ \"\")\n\na recent thread instead of this old one.\n\nIsn\u0027t the boot.ipxe a sort of \"autoexec.bat\" loaded automatically when ipxe is chainloaded?\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204125",
      "timestamp": "2017-07-16T06:49:04+00:00",
      "author": "cdob",
      "content": "\u003e IMPORTANT: Wait for the *SECOND*Ctrl+B prompt before pressing Ctrl+B\nipxe iniialiszes the network card after first Ctrl+B.  \nThere is ifopen to open the network interfaces [http://ipxe.org/cmd/ifopen](http://ipxe.org/cmd/ifopen \"External link\")  \n\nA script can be embedded [https://rom-o-matic.eu/](https://rom-o-matic.eu/ \"External link\")  \n\n```\n#!ipxe\nifopen\nifstat\nkernel file:/wimboot pause\ninitrd file:/win/bcd BCD\ninitrd file:/win/boot.sdi boot.sdi\ninitrd file:/win/boot.wim boot.wim\nimgstat\nprompt\nboot\n```\n\n.  \ngrub.cfg  \n\n```\nmenuentry \"script efi https://rom-o-matic.eu/\" {\n chainloader /ipxe_rom_o_matic_script.efi\n}\n```\n\n.  \nYes, this boots a WinPE at UEFI-mode at VMware Player.  \nIt\u0027s a debug version.  \nRead the messagges, ifstat should list a network connection.  \nPress two times enter.  \n\nStrange combination:  \nA network interface is used at local boot.  \nA network card is required for local boot.  \n\nHow to to avoid the network card requirement?  \nDoes ipxe require a network interface to mount boot.wim?   \n"
    },
    {
      "id": "204130",
      "timestamp": "2017-07-16T09:59:27+00:00",
      "author": "Wonko the Sane",
      "content": "Usal semi-random thoughts. ![:w00t:](http://reboot.pro/public/style_emoticons/default/w00t.gif) ![:ph34r:](http://reboot.pro/public/style_emoticons/default/scared9.gif)  \n\n\u003e #!ipxe  \n\u003e ifopen  \n\u003e ifstat  \n\u003e ***ifclose***   \n\u003e kernel file:/wimboot pause  \n\u003e ...\n\nWhat happens?\n\nOr is there some kind of \"virtual\" network interface (to work as a \"pass-through\" somewhat similar to a \"mountpoint\") to be used in the booting? ![:unsure:](http://reboot.pro/public/style_emoticons/default/unsure.png)\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204131",
      "timestamp": "2017-07-16T10:32:16+00:00",
      "author": "cdob",
      "content": "With ifclose added: this gives the \u0027Could not boot: No such device\u0027 error.  \nThe network interface is used at boot.  \nWell, ipxe is first about network booting.   \n"
    },
    {
      "id": "204132",
      "timestamp": "2017-07-16T12:22:01+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e With ifclose added: this gives the \u0027Could not boot: No such device\u0027 error.  \n\u003e The network interface is used at boot.  \n\u003e Well, ipxe is first about network booting.\n\nHmmm, it makes sense, of course ![:thumbup:](http://reboot.pro/public/style_emoticons/default/thumbup.gif)\n\nQuickly checking the\n\n[https://rom-o-matic.eu/](https://rom-o-matic.eu/ \"External link\")\n\nonce chosen EFI PXE bootstrap (64 bit) (which I believe it is what we are talking about) and chosen \"advanced\" there are a number of (pre-set) options/modules and a number of unset ones.\n\nMaybe the matter is about building a specific EFI file?\n\nSettings \\*like\\* \"DOWNLOAD_PROTO_FILE, Local filesystem access\" and/or \"Image types:\" and/or (possibly) contents of the various \"Command-line commands to include:\" might offer something of use (or maybe not). ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif)\n\nParticularly the:\n\n\"DOWNLOAD_PROTO_FILE, Local filesystem access\"\n\nwhich is \"commented out\" here:\n\n[https://github.com/i...onfig/general.h](https://github.com/ipxe/ipxe/blob/master/src/config/general.h \"External link\")\n\nMaybe it is something \"in progress\"?\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204246",
      "timestamp": "2017-07-24T10:25:48+00:00",
      "author": "memoarfaa",
      "content": "I see that the best solution is trying to add \"efi-stub\" to wimboot Programmatically\n\ngrub2 linuxefi \\\u0026 initrdefi command Require \"efi-stub\"\n\n[https://www.kernel.o...on/efi-stub.txt](https://www.kernel.org/doc/Documentation/efi-stub.txt \"External link\")\n\n[https://github.com/S...rnel/efi-stub.c](https://github.com/SmartisanTech/U1Kernel/blob/master/arch/arm64/kernel/efi-stub.c \"External link\")\n\n"
    },
    {
      "id": "204247",
      "timestamp": "2017-07-24T11:20:38+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e I see that the best solution is trying to add \"efi-stub\" to wimboot Programmatically  \n\u003e grub2 linuxefi \\\u0026 initrdefi command Require \"efi-stub\"  \n\u003e\n\u003e [https://www.kernel.o...on/efi-stub.txt](https://www.kernel.org/doc/Documentation/efi-stub.txt \"External link\")  \n\u003e\n\u003e [https://github.com/S...rnel/efi-stub.c](https://github.com/SmartisanTech/U1Kernel/blob/master/arch/arm64/kernel/efi-stub.c \"External link\")\nHow is this related to booting a (windows) .wim via ipxe wimboot? ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif)  \n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)  \nWonko   \n"
    },
    {
      "id": "204325",
      "timestamp": "2017-08-01T09:56:01+00:00",
      "author": "ndog37",
      "content": "The reason why I want grub2 efi is because it is a signed EFI, eg works with secureboot ![:thumbsup:](http://reboot.pro/public/style_emoticons/default/thumbsup.gif)\n\niPXE + wimboot is easy, but does not support secure boot. ![:blowup:](http://reboot.pro/public/style_emoticons/default/blowup.gif)\n\n"
    },
    {
      "id": "204327",
      "timestamp": "2017-08-01T10:13:46+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e The reason why I want grub2 efi is because it is a signed EFI, eg works with secureboot ![:thumbsup:](http://reboot.pro/public/style_emoticons/default/thumbsup.gif)   \n\u003e\n\u003e iPXE + wimboot is easy, but does not support secure boot. ![:blowup:](http://reboot.pro/public/style_emoticons/default/blowup.gif)\n\nBut you asked about it, originally:  \n\n\u003cbr /\u003e\n\n\u003e Hi there  \n\u003e\n\u003e I am keen to know if anyone could get wimboot + grub UEFI pxe boot working.\n\nIt seems like Steve6375 and cdob answered to THAT question just fine. ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif)  \n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)  \nWonko   \n"
    },
    {
      "id": "204329",
      "timestamp": "2017-08-01T10:53:37+00:00",
      "author": "ndog37",
      "content": "Hi wonko, steve etc thanks for your reply.  \n\nI should have clarified that more clearly in the OP, my bad sorry.  \n\nUsing iPXE.efi as an intermediate step will defeat the purpose of this exercise which is to make [wimboot](http://forum.ipxe.org/showthread.php?tid\u003d8290\u0026pid\u003d13384#pid13384 \"External link\") work over EFI network boot with secure boot.\n\nIf we use ipxe.efi in the booting stage it will fail on a secure boot system, it is not signed unfortunately, as [microsoft want our money](http://forum.ipxe.org/showthread.php?tid\u003d7843\u0026pid\u003d11945#pid11945 \"External link\").\n\n**Edited by ndog37, 01 August 2017 - 11:12 AM.**\n"
    },
    {
      "id": "204332",
      "timestamp": "2017-08-01T15:27:47+00:00",
      "author": "Wonko the Sane",
      "content": "Yep, maybe, rather than signing the ipxe.efi one could use something \\*like\\* shim.efi or preloader.efi:\n\n[http://www.rodsbooks...secureboot.html](http://www.rodsbooks.com/efi-bootloaders/secureboot.html \"External link\")\n\n[http://www.rodsbooks...ml#using_signed](http://www.rodsbooks.com/efi-bootloaders/secureboot.html#using_signed \"External link\")\n\nBut really no idea if possible at all. ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif)\n\nOn the other hand, using your own keys might be possible:\n\n[http://www.rodsbooks...rolling-sb.html](http://www.rodsbooks.com/efi-bootloaders/controlling-sb.html \"External link\")\n\nthough defintiely not for the faint of heart ![:ph34r:](http://reboot.pro/public/style_emoticons/default/scared9.gif)\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "214547",
      "timestamp": "2020-05-09T15:18:08+00:00",
      "author": "nogera",
      "content": "Hi,\n\nI\u0027m chainloading from grub2 to ipxe but the interface disappears everytime after the chainload.\n\nchainloader /ipxe.efi\n\nboot\n\niPXE initialising devices... (it\u0027s just stuck there)\n\nchainloader /snponly.efi\n\nboot\n\nno more network device\n\nI checked the interface in grub before the chainloader to make sure it works. i also tried to chainload grub2 with grub2 to test if it was an issue with ipxe but same results, no interface after chainloading.\n\nAnyone know what I\u0027m doing wrong?\n\n"
    }
  ]
}