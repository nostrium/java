{
  "id": "21403",
  "title": "How to copy locked Windows files?",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "202020",
      "timestamp": "2017-02-05T09:43:45+00:00",
      "author": "steve6375",
      "content": "I have a USB drive that contains a WindowsToGo flat-file installation on a 16GB NTFS single partition.\n\nSo it has a normal Windows folder structure \\\\Users, \\\\Program Files, \\\\Windows, etc.\n\nI want to make a fixed VHD of 16GB containing all those files.\n\nI don\u0027t want to use any VHD tools because the USB drive is a 500GB drive containing a 16GB NTFS partition. I need to make a fixed VHD from it of approx. 16GB (not a 500gb VHD!). i.e. I don\u0027t want a fixed VHD of the whole USB drive.\n\nI created a new empty 16GB fixed .VHD file, attached it and formatted it as NTFS.\n\nI am running on a normal MBR-booting Win10 x64 SSD system (it was Home but I have now upgraded it to Pro).\n\nNow I want to copy all the files from the WinToGo USB drive to the VHD.\n\nThe problem is when the copy process hits certain files (mostly in the \\\\Windows folder), it fails to copy them.\n\nI have tried xcopy, robocopy, Hobocopy, Shadospawn, spyhunter, OSForensic, VSSCopy and many other tools - all without success. They all report copy errors. I suspect because Win10 may be getting confused and thinks that some of these files are actually it\u0027s own system OS files (i.e. it *thinks*it is running WinToGo) and so not allowing access to them?\n\nI have not tried WinPE (or forensic PE), I suspect that these may work, but that is not the point. I want to copy the files from a normal Windows 10 system.\n\nDoes anyone have any ideas?\n\nP.S. I am trying robocopy /B /MIR again and it seems to be working so far... I did try this before when I had Win 10 Home and I don\u0027t think it worked (if I remember correctly). So maybe /B requires Pro or higher for VSS???\n\nScratch that! - it is following the symbolic links- e.g. it hits the My Documents symbolic link and then tries to copy all my Windows OS\u0027s Documents folder! If I use the /sl switch, then I get \u0027program cannot access the file\u0027) when trying to access my Documents and Settings\\\\Steve\\\\ntuser.dat file, etc....\n\n**Edited by steve6375, 05 February 2017 - 10:14 AM.**\n"
    },
    {
      "id": "202022",
      "timestamp": "2017-02-05T10:12:36+00:00",
      "author": "Wonko the Sane",
      "content": "Sure, lot of them ideas, and also (hopefully) a solution.\n\nHere:\n\n[http://reboot.pro/to...s-now-possible/](http://reboot.pro/topic/7400-copy-locked-system-files-tis-now-possible/ \"\")\n\nAs a side note please take into account (you will have to check if this applies) that starting from Windows Vista (and increasingly in 7 and later) there is wide use of hardlinks, thus a file (even if copied correctly) may result in a new instance of the file, and as such will occupy more space than the original.\n\nJFYI (if needed):  \n[http://schinagl.priv...lextension.html](http://schinagl.priv.at/nt/hardlinkshellext/linkshellextension.html \"External link\")\n\nThis said, in your specific case, I am pretty sure that you can easily create a RAW file containing a dd-like copy of the 16 Gb partition (+a MBR and hidden sectors) and then \"convert\" it to \"fixed VHD\" (i.e. add the CONECTIX footer), manually or using a dedicated tool \\*like\\* Clonedisk or the simpler:  \n[http://reboot.pro/to...mand-line-tool/](http://reboot.pro/topic/16035-vhd2img-command-line-tool/ \"\")\n\n[http://reboot.pro/to...images/?p\u003d83781](http://reboot.pro/topic/9715-firadisk-and-vhd-img-images/?p\u003d83781 \"\")\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "202023",
      "timestamp": "2017-02-05T10:29:49+00:00",
      "author": "steve6375",
      "content": "Yes, thanks, the symbolic link issue is the one I am hitting now! See P.S. on first post!\n\nI either need to \u0027raw copy\u0027 the whole volume, or maybe somehow offline it and then copy all files?\n\nI can make a dynamic VHD from the 500GB USB drive using tools like DisktoVHD (which makes a 500GB dynamic VHD of about 17GB in size) and then reduce\\\\convert this to a fixed\\\\static VHD but this gives me a 31GB VHD when I only want a 16GB VHD containing 10GB of files...\n\n"
    },
    {
      "id": "202024",
      "timestamp": "2017-02-05T10:39:38+00:00",
      "author": "Wonko the Sane",
      "content": "Forget (temporarily) about the VHD.\n\nThink RAW.\n\nUse a sparse file (for the target image).\n\nIf the 16 Gb partition is first partition on the \"source\" disk then you can do a (partial) dd-like image just fine (nad then edit the MBR partition table to remove addresses of \"other\" partition(s)).\n\nIf the partition is not the first one, you can still create a (sparse) target image of suitable size, write to it the MBR and the \"sectors before\", dd the volume then correct the \"sectors before\" (as said I am pretty sure you can do that just fine), and finally convert the whole stuff to (static) VHD.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "202026",
      "timestamp": "2017-02-05T10:51:59+00:00",
      "author": "Guest_AnonVendetta_*",
      "content": "Have you tried mounting the Windows volume offline from Linux, then copying from there? Not sure if this would be a good approach, since permissions/owners might not be retained intact.\n\nOr maybe you can robocopy but use whatever switches allow for excluding symlinks/junctions, then manually recreate them?\n\nIf all else fails, raw copying will surely work.\n\n"
    },
    {
      "id": "202027",
      "timestamp": "2017-02-05T11:05:07+00:00",
      "author": "Wonko the Sane",
      "content": "Alternatively, since you are into experimenting, see if strarc (possibly with a few tricks) can be used for 10 as well (it should):  \n[https://tinyapps.org...eplacement.html](https://tinyapps.org/blog/windows/201510120715_robocopy_replacement.html \"External link\")\n\nStrarc solves elegantly the link issues, in case you have errors with 8.3 compatibility messages:\n\n[http://serverfault.c...y/650290#650290](http://serverfault.com/questions/648527/mirroring-harddisk-with-compressed-files-with-robocopy/650290#650290 \"External link\")\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "202030",
      "timestamp": "2017-02-05T11:13:43+00:00",
      "author": "Zoso",
      "content": "hi steve6375,  \n\ntry earlier versions of clondisk, i use 1.9.6 for this (file copy option) and it has the option to also copy ACLs or not.  \n\nhaving wrote this, I have not used this method for w8 and later but it may be worth a try.  \n\nI run it from XP most of the time also and find XP does not have as many issues with copy/paste operations as the later MS version do.   \n"
    },
    {
      "id": "202031",
      "timestamp": "2017-02-05T11:18:54+00:00",
      "author": "steve6375",
      "content": "I can make a partition image using RMPrepUSB - Drive-\\\u003eFile - P1 (actually it is a .imgPTN file already).\n\n7zip can open this image as an archive.\n\nI can then extract the files to the new 16GB VHD.\n\nBut 7zip does not like some files, e.g. \\\\System Volume Information\\\\WPSettings.dat (which doesn\u0027t matter) and cannot create \\\\Users\\\\All Users symbolic link, etc.\n\nI think the only way this is going to work properly is by working with raw images (as WtS says)...  \n\n"
    },
    {
      "id": "202033",
      "timestamp": "2017-02-05T11:26:13+00:00",
      "author": "Vortex",
      "content": "Hi steve6375,\n\nYou can try the the strarc tool with the volume shadow copy client to copy locked files :\n\n[http://ltr-data.se/opencode.html/](http://ltr-data.se/opencode.html/ \"External link\")\n\n[http://vscsc.sourceforge.net/](http://vscsc.sourceforge.net/ \"External link\")\n\nAbout strarc :\n\n\u003e The command line switches and parameters are quite similar to the \\*nix tar utility and it can easily be used to clone an entire NTFS volume including everything, files, directories, their time stamps, attributes and security information, compression attribute, alternate data streams, junctions, hard links etc.\n\u003e\n\u003e Example:  \n\u003e\n\u003e strarc -cjd:C:\\\\dir \\| strarc -xd:D:\\\\dirbk  \n\u003e\n\u003e This will clone the C:\\\\dir directory tree to D:\\\\dirbk but will not follow  \n\u003e junctions in the C:\\\\dir directory tree but instead clone the junction itself to  \n\u003e the D:\\\\dirbk location. Example: If there is a volume mount point C:\\\\dir\\\\mnt  \n\u003e then a new junction D:\\\\dirbk\\\\mnt will be created to point to the same volume,  \n\u003e the contents of the target volume of the mount point will not be copied.\n\u003e\n[http://ltr-data.se/files/strarc.txt](http://ltr-data.se/files/strarc.txt \"External link\")  \n\n"
    },
    {
      "id": "202035",
      "timestamp": "2017-02-05T11:52:44+00:00",
      "author": "steve6375",
      "content": "Thanks! :smile:\n\nstrarc works perfectly!\n\nI had a Windows Server 2016 installation as a flat file inside a .imgPTN file and I wanted to convert this to a .VHD file.\n\nI switched to the .imgPTN file ( seen as D: by Windows) and mounted a new 16GB fixed VHD as Q:\n\n\u003e C:\\\\temp\\\u003estrarc.exe -cjd:d:\\\\ \\| strarc -xd:q:\\\\  \n\u003e strarc: Cannot create \u0027System Volume Information\\\\IndexerVolumeGuid\u0027: Cannot create a file when that file already exists.  \n\u003e strarc: Cannot create \u0027System Volume Information\\\\WPSettings.dat\u0027: Cannot create a file when that file already exists.\n\u003e\nI copied the VHD file to my E2B drive and I can now boot from the VHD file to Windows Server 2016!\n\n![:lol:](http://reboot.pro/public/style_emoticons/default/laugh.png)\n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "202038",
      "timestamp": "2017-02-05T12:38:51+00:00",
      "author": "Vortex",
      "content": "Hi steve6375,\n\nOlof Lagerkvist\u0027s strarc is very powerful. There is an option to exlude paths and files :\n\n\u003e ```\n\u003e strarc -c [-afjnr] [-z:CMD] [-m:f|d|i] [-l|v] [-s:ls8] [-b:SIZE]\n\u003e        [-e:EXCLUDE[,...]] [-i:INCLUDE[,...]] [-d:DIR] [ARCHIVE] [LIST ...]\n\u003e ```\n\u003e\n\u003e ```\n\u003e -e     Exclude paths and files where any part of the relative path matches any\n\u003e        string in specified comma-separated list.\n\u003e ```\n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "202039",
      "timestamp": "2017-02-05T12:47:55+00:00",
      "author": "Wonko the Sane",
      "content": "Those \"System Voiume Information\" related errors may most probably be avoided by stopping the Windows Search service, that seems like a \\*new\\* thing in windows 8.x and later, coincidentally:  \n[http://www.msfn.org/...-attached-vhds/](http://www.msfn.org/board/topic/176446-windows-81-issue-system-volume-information-on-attached-vhds/ \"External link\")\n\nFrom what I can understand, as soon as you attach the .vhd, the OS (the Windows Search service) instantly creates the \"System Volume Information\" folder, and when strarc copies it those files are already present.\n\nAnd, just to keep things as together as possible, the original report by Vortex ![:thumbsup:](http://reboot.pro/public/style_emoticons/default/thumbsup.gif) about using VSS (also cited in the given tinyapps page):  \n[http://reboot.pro/to...-copy/?p\u003d173053](http://reboot.pro/topic/18592-backup-a-live-windows-system-with-strarc-and-volume-shadow-copy/?p\u003d173053 \"\")\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "202040",
      "timestamp": "2017-02-05T12:50:25+00:00",
      "author": "steve6375",
      "content": "Yes, there is [a way of stopping it](http://rmprepusb.blogspot.co.uk/2014/12/deleting-system-volume-information.html \"External link\") by deleting the folder and then quickly making a file of the same name...\n\n"
    },
    {
      "id": "202041",
      "timestamp": "2017-02-05T12:54:26+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e Yes, there is [a way of stopping it](http://rmprepusb.blogspot.co.uk/2014/12/deleting-system-volume-information.html \"External link\") by deleting the folder and then quickly making a file of the same name...\n\nYep :smile:, but that doesn\u0027t solve the issue at all, that way it will anyway prevent the strarc from copying the original one, disabling the Windows Search before attaching the target vhd should allow strarc to operate correctly and copy the original to the target.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "202070",
      "timestamp": "2017-02-06T18:53:19+00:00",
      "author": "Olof Lagerkvist",
      "content": "Missed this thread yesterday but you have already found strarc and it looks like you got it to work correctly for you. What I usually do in these cases is also using a shadow copy and then use strarc to copy all files but adding the **-e** switch to skip some. In particular I usually:\n\n**strarc -c -j -e:\"System Volume Information,\\\\Temp\\\\,\\\\Temporary Internet Files\\\\,\\\\Cache\\\\,.tmp,pagefile.sys,hiberfil.sys,\\\\$NtUninstall\"**\n\nDon\u0027t forget the **-j** switch. It is important to use that switch to get all symbolic links, junctions etc correct. It is not needed for hard links though, they are archived only once even without special switches. (You can select if you want to archive or extract them as separate files using **-s:l** switch though.)\n\n"
    },
    {
      "id": "204071",
      "timestamp": "2017-07-08T19:18:43+00:00",
      "author": "steve6375",
      "content": "any ideas why this line in a cmd script which is run as admin causes the cmd shell to immediately close?\n\n```\nif \"%BIT%\"\u003d\u003d\"64\" strarc.exe -ovcjd:%~dp0Files\\x64 | strarc -oxd:%SystemDrive%\\mount4\n```\n\nI can run the command from an Admin shell without problem (when the boot.wim is mounted).\n\nThe cmd file mounts a boot.wim to C:\\\\mount4 using DISM and then attempts to copy over some files from the xotf folder on the Desktop. I am using strarc because xcopy will not copy winpeshl.ini to C:\\\\mount4\\\\windows\\\\system32.\n\n```\necho BIT\u003d%BIT%\n::if \"%BIT%\"\u003d\u003d\"32\" xcopy /cherkyf \"%~dp0Files\\x86\\*.*\" \"%SystemDrive%\\mount4\\*.*\"\n::if \"%BIT%\"\u003d\u003d\"64\" xcopy /cherkyf \"%~dp0Files\\x64\\*.*\" \"%SystemDrive%\\mount4\\*.*\"\nif \"%BIT%\"\u003d\u003d\"32\" strarc.exe -ovcjd:%~dp0Files\\x86 | strarc -oxd:%SystemDrive%\\mount4\nif \"%BIT%\"\u003d\u003d\"64\" echo strarc.exe -ovcjd:%~dp0Files\\x64 ^| strarc -oxd:%SystemDrive%\\mount4\npause\nif \"%BIT%\"\u003d\u003d\"64\" strarc.exe -ovcjd:%~dp0Files\\x64 | strarc -oxd:%SystemDrive%\\mount4\npause\n```\n\nThe blue console shows the result just before the strarc line is executed...\n\nAny ideas appreciated...\n\nP.S. Also not sure what the message about the setup.bmp file means and also not sure if I should enclose filespecs in double-quotes in case of spaces in paths\\\\filenames?\n\n#### Attached Thumbnails {#attach_wrap}\n\n* [![Capture_strarc.JPG](http://reboot.pro/uploads/monthly_07_2017/post-17818-0-94321000-1499540896_thumb.jpg)](http://reboot.pro/uploads/monthly_07_2017/post-17818-0-94321000-1499540896.jpg \"Capture_strarc.JPG - Size: 43.1KB\"){#ipb-attach-url-16032-0-06849800-1676066440}\n* [![Capture_strarccrash.JPG](http://reboot.pro/uploads/monthly_07_2017/post-17818-0-88008600-1499541151_thumb.jpg)](http://reboot.pro/uploads/monthly_07_2017/post-17818-0-88008600-1499541151.jpg \"Capture_strarccrash.JPG - Size: 68.28KB\"){#ipb-attach-url-16033-0-06859600-1676066440}\n\n"
    },
    {
      "id": "204074",
      "timestamp": "2017-07-09T07:42:07+00:00",
      "author": "Wonko the Sane",
      "content": "The \"setup.bmp\" seems like an issue with a reparse point, do check the source filesystem.\n\nThe closing of the cmd windows is \"strange\", I don\u0027t think anything \"queer\" at face value, does the \"32 bit version\" work or does it not?\n\nTry:\n\nif \"%BIT%\"\u003d\u003d\"64\" strarc.exe -ovcjd:%\\~dp0Files\\\\x64 \\| strarc -oxd:%SystemDrive%\\\\mount4 \\\u0026\\\u0026 ECHO executed\\\u003etemp.txt\n\nif \"%BIT%\"\u003d\u003d\"64\" strarc.exe -ovcjd:%\\~dp0Files\\\\x64 \\| strarc -oxd:%SystemDrive%\\\\mount4 \\|\\| ECHO failed\\\u003etemp.txt\n\nand also:\n\nif \"%BIT%\"\u003d\u003d\"64\" strarc.exe -ovcjd:%\\~dp0Files\\\\x64 \\| strarc -oxd:%SystemDrive%\\\\mount4 \\\u003etemp.txt\n\nTo hopefully see if the thing runs, and if it does where it chokes.\n\nYou\u0027ll have to check if strarc outputs to standard or error console (Olof\u0027s tools usually output to error).\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204075",
      "timestamp": "2017-07-09T07:56:56+00:00",
      "author": "steve6375",
      "content": "I tried that and also\n\n\\\u0026 echo xxx \\\u003e C:\\\\temp\\\\a.log\n\nand also\n\n2\\\u003e C:\\\\temp\\\\a.log to catch strarc errors\n\nand also\n\n\\\u003e C:\\\\temp\\\\a.log\n\nthere was no file made, not even an empty file...\n\nOn a side note, I found a workaround using xcopy only...\n\nIf I rename the winpeshl.ini file first (e.g. winpeshl.txt)\n\nthen do the xcopy of the folder\n\nthen rename C:\\\\mount4\\\\windows\\\\system32\\\\winpeshl.txt to winpeshli.ini Windows allows it!\n\n"
    },
    {
      "id": "204076",
      "timestamp": "2017-07-09T08:23:25+00:00",
      "author": "steve6375",
      "content": "SOLVED!\n\nI was debugging someone else\u0027s batch file and they had not set the current root folder!\n\nSo strarc.exe did not exist and the .cmd shell just bombed out!\n\nThe fact that no log file (not even an empty one) gave me the clue.\n\nsorry for the hassle!\n\n"
    },
    {
      "id": "204077",
      "timestamp": "2017-07-09T09:16:34+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e I tried that and also\n\u003e\n\u003e ...\n\u003e\n\u003e there was no file made, not even an empty file...\n\nI guess it is an \"edge case\", due to the presence of the pipeline in the strarc command, something like:\n\nNOPROG\\|NOPROG\\|\\|ECHO FAILEDNOPROG\\\u003etemp.txt\n\nWon\u0027t work, as well as:\n\nNOPROG\\|NOPROG\\\u003etemp.txt\n\nand not even:\n\nNOPROG\\|NOPROG 2\\\u003etemp.txt\n\nThe error is thrown in the first command, which is not redirected, because it is piped, and since it is piped to a non existing program, there is no redirected output...\n\n\u003e SOLVED!\n\u003e\n\u003e I was debugging someone else\u0027s batch file and they had not set the current root folder!\n\u003e\n\u003e So strarc.exe did not exists and the .cmd shell just bombed out!\n\u003e\n\u003e The fact that no log file (not even an empty one) gave me the clue.\n\u003e\n\u003e sorry for the hassle!\n\nAll is well that is well :smile:, but still it shouldn\u0027t have \"bombed out\" ![:dubbio:](http://reboot.pro/public/style_emoticons/default/dubbio.gif) should have printed a \"xxxx is not recognized as an internal command ...\"\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204078",
      "timestamp": "2017-07-09T09:21:45+00:00",
      "author": "steve6375",
      "content": "very strange though that Windows xcopy will fail when copying winpeshl.ini to C:\\\\mount4\\\\windows\\\\system32 !!!\n\nStrange in that winpeshl.ini is not used by Windows AFAIK (winpe yes, but not Windows OS) ???\n\nAlso that it does not check that it is a (root)\\\\windows\\\\system32 path.\n\nIf it is supposed to be an AV measure, then why does it allow renaming winpeshl.txt to winpeshl.ini in the same folder?\n\n"
    }
  ]
}