{
  "id": "21633",
  "title": "rebuild bootmgr, repair mbr of a bootable usb stick",
  "isPinned": false,
  "isFirstTopic": false,
  "isLocked": false,
  "tags": [],
  "forumNotes": [
    {
      "id": "204837",
      "timestamp": "2017-11-14T19:35:10+00:00",
      "author": "matrix.rebooted",
      "content": "Hello,  \n\nI forgot my stick in the usb port while trying to repair windows... :smile: Now I have a message bootmgr missing when I try to boot to the usb.\n\nIt was a multiboot usb created with yumi (syslinux and grub4dos isos). Content is unchanged so I was wondering if there is a way to repair it (rebuild bcd/bootmgr/mbr, I don\u0027t know which one...), and from windows now.., without formatting or if I have to recreate it from the beginning...  \n\nThank you\n\n**Edited by matrix.rebooted, 14 November 2017 - 07:38 PM.**\n"
    },
    {
      "id": "204838",
      "timestamp": "2017-11-14T20:10:04+00:00",
      "author": "Wonko the Sane",
      "content": "The message \"bootmgr missing\" may come from either syslinux, grub4dos or the actual \"normal\" bootsector/PBR/VBR of the windows (actually it is more likely from the last).\n\nBasically it should mean (I am assuming BIOS or UEFI/CSM booting since you mentioned grub4dos) that the file \"bootmgr\" is missing from the root of the stick, but it may depend on a number of variables.\n\nIt is likely that what happened is the following (but no way to know without more details):\n\n1) the USB had a MBR invoking directly another bootloader (such as grub4dos, often installed this way)\n\n2) during the repair the MBR was replaced with the standard Windows one (that chainloads the PBR of the active parittion)\n\n3) the previous bootloader did not chainload directly the BOOTMGR in the root of the stick but mounted an image (or however used a different path).\n\nOR:\n\n1) the USB had a normal MBR (chainloading the PBR of the active partition)\n\n2) the PBR invoked Syslinux (this is the normal way Syslinux is installed, more rare that grub4dos was chainloaded by it)\n\n3) during the repair the PBR was replaced by the standard Windows PBR code (invoking BOOTMGR)\n\nWhat was the actual FIRST menu you had before?\n\nWas it a Syslinux one or a grub4dos one?\n\nDo you have a \"bootmgr\" file in root of the stick? (my guess is no)\n\nIf you have a \"grldr\" file on the stick (in root or elsewhere) you can try making a copy of it and place the copy in root, renamed as \"bootmgr\".\n\nThis may or may not give you access to grub4dos (depends on a number of factors).\n\nIf it does then we will find out a way to repair the setup.\n\nIf you have either a syslinux.cfg or a menu.lst (or both) post its (their) contents, maybe we can understand from them how your stick was setup.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204843",
      "timestamp": "2017-11-14T22:53:34+00:00",
      "author": "matrix.rebooted",
      "content": "thank you for the reply,\n\n\u003e It is likely that what happened is the following (but no way to know without more details):  \n\u003e\n\u003e What was the actual FIRST menu you had before?  \n\u003e\n\u003e Was it a Syslinux one or a grub4dos one?  \n\nHard drive comes with Win7 with BIOS, it is fixed now, it works (using it right now). USB has been formatted and installed with Yumi and first menu was syslinux, then grub4dos from a menu entry, leading to win iso.  \n\nLooking at the usb stick after my mistake, I saw that the win7 dvd repair tool installed a \\\\boot folder on it (wasn\u0027t there before), and editing the file BCD within with easybcd shown me the classical \"start windows 7\" menu entry that normally should have been written on the hard drive.  \n\u003e Do you have a \"bootmgr\" file in root of the stick?\n\nI guess it is this BCD? (was in \\\\boot, like windows)  \n\u003e If you have a \"grldr\" file on the stick (in root or elsewhere) you can try making a copy of it and place the copy in root, renamed as \"bootmgr\".\n\nDeleted \\\\boot folder of the stick and done as you said (grldr is in \\\\HBCD): it worked! Well, at least it is bootable again.  \n\nI have several menu entries, as you can see in the files below, but now there is no more \u0027theme\u0027 applied (splash image, text color,..) but more importantly, it shows directly the menu of hiren\u0027s bcd, that is the first entry of the syslinux file, as if I had choosen it (pressing 1)... and strangely, without \u0027pre-\u0027 loading hiren\u0027s bcd (the embedded progs like dos, memtest, parted magic, etc of the cd are working)\n\nEDIT: in fact this menu comes from the default isolinux.cfg and menu.lst in \\\\HBCD where I took grldr from, that\u0027s why! but there is no other grldr. All yumi and syslinux files are in \\\\multiboot.(I saw a file named \u0027wimboot\u0027, tried to do the same, but no effect). And that\u0027s the only two root folders.  \n\u003e If you have either a syslinux.cfg or a menu.lst (or both) post its (their) contents, maybe we can understand from them how your stick was setup.\n\n\\\\multiboot\\\\syslinux.cfg\n\n```\n################## SYSLINUX menu entries# W.I.P.#################UI vesamenu.c32TIMEOUT 600MENU TITLE Universal MultiBoot LiveUSB repair discMENU BACKGROUND yumi_lazero.pngMENU TABMSG  -Y-U-M-I-MENU WIDTH 72MENU MARGIN 10MENU VSHIFT 3MENU HSHIFT 6MENU ROWS 15MENU TABMSGROW 20MENU TIMEOUTROW 22menu color title 1;36;44 #66A0FF #90D00000 nonemenu color hotsel 0;31;47 #C00000 #DDFFFFFFmenu color hotkey 31;47 #C00000 #DDFFFFFFmenu color unsel 37;44 #FFFFFF #6066A0FF nonemenu color sel 30;47 #000000 #FFFFFFFFmenu color border 30;44\t#D00000 #00000000 stdmenu color scrollbar 30;44 #DDDDDDDD #00000000 noneLABEL Boot from first Hard DriveMENU LABEL  Continue to Boot from ^First HD (default)KERNEL chain.c32APPEND hd1MENU DEFAULT#start ubuntu_boot_repair_disk_32bitLABEL ubuntu_boot_repair_disk_32bitMENU LABEL ^1 Ubuntu Boot_Repair_Disk_32bitMENU INDENT 1CONFIG /multiboot/ubuntu_boot_repair_disk_32bit/isolinux/isolinux.cfgAPPEND /multiboot/ubuntu_boot_repair_disk_32bit/isolinux#end ubuntu_boot_repair_disk_32bit#start Hiren.s.BootCD.15.2.FR.KeyboardLABEL Hiren\u0027s Boot CD (Hiren.s.BootCD.15.2.FR.Keyboard)MENU LABEL ^2 Hiren\u0027s Boot CD 15.2 Kbrd FrMENU INDENT 1COM32 /HBCD/Boot/chain.c32 ntldr\u003d/HBCD/grldr#end Hiren.s.BootCD.15.2.FR.Keyboard#start gparted_0.30.0_1_i686LABEL gparted_0.30.0_1_i686MENU LABEL ^3 Gparted 0.30.0_1_i686MENU INDENT 1CONFIG /multiboot/gparted_0.30.0_1_i686/syslinux/syslinux.cfgAPPEND /multiboot/gparted_0.30.0_1_i686/syslinux#end gparted_0.30.0_1_i686#start clonezilla-liveusb-20170905-zesty-i386LABEL clonezilla-liveusb-20170905-zesty-i386MENU LABEL ^4 Clonezilla 20170905-zesty-i386 (ubuntu alt.)MENU INDENT 1CONFIG /multiboot/clonezilla-liveusb-20170905-zesty-i386/syslinux/syslinux.cfgAPPEND /multiboot/clonezilla-liveusb-20170905-zesty-i386/syslinux#end clonezilla-liveusb-20170905-zesty-i386#start systemrescuecd_x86_5.1.2LABEL systemrescuecd_x86_5.1.2MENU LABEL ^5 SystemRescueCD x86_5.1.2MENU INDENT 1CONFIG /multiboot/systemrescuecd_x86_5.1.2/isolinux/isolinux.cfgAPPEND /multiboot/systemrescuecd_x86_5.1.2/isolinux#end systemrescuecd_x86_5.1.2label Unlisted ISOs (via GRUB) -\u003emenu label ^6 Win ISOs via Grub (Win7RE, Malekal7PE \u0026 more)MENU INDENT 1KERNEL /multiboot/grub.exeAPPEND --config-file\u003d/multiboot/menu/menu.lst\n```\n\n\\\\multiboot\\\\menu\\\\menu.lst\n\n```\n################## Grub4dos menu entries# W.I.P.#################default 8timeout 30###################keymap azerty fr#################### set AZERTY ketyboard#[...] removed to post########theme########graphicsmode -1 640 480color normal\u003d0x4670ba highlight\u003d0x4670baffcf40 heading\u003d0xead61c helptext\u003d0xead61c border\u003d0xead61c standard\u003d0xFFFFFFsplashimage\u003d/multiboot/grub_4k.jpg############menu settings############# ~80col/25ln maxset wdspace\u003d0set lnspace\u003d0set bdwidth\u003d1set tophelp\u003d24set noitems\u003d10set topstart\u003d4set menuw\u003d68set rstart\u003d7# u restore max menu grub4dos default/multiboot/menu/menusetting.gz u/multiboot/menu/menusetting.gz   %wdspace% %lnspace% %bdwidth% %tophelp% %noitems% %topstart% %menuw% %rstart%#######MENU#######title               --- Windows ISOs Bootable via GRUB ---roottitleroottitle \u003c--- Back to Main Menuroot (hd0,0)chainloader (hd0)+1rootnoverify (hd0)#start Malekal_RepairKit#Modify the following entry if it does not boottitle Boot Malekal win7PESEfind --set-root --ignore-floppies --ignore-cd /multiboot/ISOS/Malekal_RepairKit.isomap --heads\u003d0 --sectors-per-track\u003d0 /multiboot/ISOS/Malekal_RepairKit.iso (hd32)map --hookchainloader (hd32)#end Malekal_RepairKit#start Windows_7_32-bit_Repair_Disc#Modify the following entry if it does not boottitle Boot Windows 7 Repair_Disc_32bitsfind --set-root --ignore-floppies --ignore-cd /multiboot/ISOS/Windows_7_32-bit_Repair_Disc.isomap --heads\u003d0 --sectors-per-track\u003d0 /multiboot/ISOS/Windows_7_32-bit_Repair_Disc.iso (hd32)map --hookchainloader (hd32)#end Windows_7_32-bit_Repair_Disc#start DaRT8.1x86#Modify the following entry if it does not boottitle Boot DaRT 8.1 x86 32 BITSfind --set-root --ignore-floppies --ignore-cd /multiboot/ISOS/DaRT8.1x86.isomap --heads\u003d0 --sectors-per-track\u003d0 /multiboot/ISOS/DaRT8.1x86.iso (hd32)map --hookchainloader (hd32)#end DaRT8.1x86#start DaRT8.1x64#Modify the following entry if it does not boottitle Boot DaRT 8.1 x64 64 BITSfind --set-root --ignore-floppies --ignore-cd /multiboot/ISOS/DaRT8.1x64.isomap --heads\u003d0 --sectors-per-track\u003d0 /multiboot/ISOS/DaRT8.1x64.iso (hd32)map --hookchainloader (hd32)#end DaRT8.1x64#start Win98SE_bootdisk#Modify the following entry if it does not boottitle Boot Win98SE_bootdisk.isofind --set-root --ignore-floppies --ignore-cd /multiboot/ISOS/Win98SE_bootdisk.isomap --heads\u003d0 --sectors-per-track\u003d0 /multiboot/ISOS/Win98SE_bootdisk.iso (hd32)map --hookchainloader (hd32)#end Win98SE_bootdisktitle Reboot the USB\\n %@DATE% %@TIME%reboot\n```\n\n\u003cbr /\u003e\n\n**Edited by matrix.rebooted, 14 November 2017 - 11:37 PM.**\n"
    },
    {
      "id": "204855",
      "timestamp": "2017-11-15T14:08:44+00:00",
      "author": "matrix.rebooted",
      "content": "So, I really don\u0027t know what I am doing :smile: but found some threads and tried this if it can help:  \n\n- tested mbrview.g4b (rd)\n\nSpoiler  \n[https://imgur.com/Kofibyg](https://imgur.com/Kofibyg \"External link\")\n\n- tested diskpart : nothing special? the offset perhaps?\n\nSpoiler  \n[https://imgur.com/bkW2wjL](https://imgur.com/bkW2wjL \"External link\")\n\n- tested ptedit32 :\n\nSpoiler  \n[https://imgur.com/ePiJYtc](https://imgur.com/ePiJYtc \"External link\")\n\nWas thinking win could have created its 100Mo reserved partition, but doesn\u0027t seem to be the case...\n\n**Edited by matrix.rebooted, 15 November 2017 - 02:32 PM.**\n"
    },
    {
      "id": "204856",
      "timestamp": "2017-11-15T15:05:45+00:00",
      "author": "Wonko the Sane",
      "content": "Good. :smile:  \nSo, your primary bootloader was Syslinux, and what was overwritten was the PBR (or bootsector) of the active primary partition.  \n\nNow it is a matter of replacing the current one (which is the default Windows 7 one) with the Syslinux one.  \n\nTo reinstall the Syslinux PBR, you could simply run the install command from a copy of Syslinux:  \n[http://www.syslinux....Install#Windows](http://www.syslinux.org/wiki/index.php?title\u003dInstall#Windows \"External link\")  \n\nIn your case (let\u0027s say that the partition/volume gets drive letter \"U:\") that would be:  \nsyslinux.exe -d /multiboot/syslinux/ -i U:  \n\nBut you will have to check if you have anywhere on the stick a Syslinux.exe, otherwise you will need to download a new copy making sure to get the same version as the already installed one.  \n\nSo, before running the above, try getting a \"suitable\" Syslinux.exe and run instead (still assuming that U: is the drive letter):  \nsyslinux.exe -f -d /multiboot/syslinux/ -i U: U:\\\\multiboot\\\\syslinux.bin  \n\nThis will create in U:\\\\multiboot\\\\ a new file syslinux.bin which is a copy of what would be written to the PBR if you used the \"normal\" install command, see also:  \n[http://www.rmprepusb...inload-syslinux](http://www.rmprepusb.com/tutorials/chainload-syslinux \"External link\")  \n\n\u003cbr /\u003e\n\nNow, if you boot from the stick (and get to the the grub4dos menu) you can press \"c\" (to get to grub4dos command line) and in it issue a few commands:  \nroot \\[ENTER\\] \\\u003c- this should output the current root, likely \"(hd0)\"  \nchainloader /multiboot/syslinux.bin \\[ENTER\\] \\\u003c- this chainloads Syslinux, you can press \\[TAB\\] to use command line autocompletion  \nboot \\[ENTER\\] \\\u003c- this should boot Syslinux  \n\nIf everything looks \"fine\" (i.e. as before), then you can run the actual install command seen earlier.  \n\nI would anyway (before anything else) make a backup copy of the current bootsector (you never know).  \nDepending on the filesystem in use (I presume FAT32, but could be NTFS) on the volume the procedure might be slightly different, but all in all if you copy the first 16 sectors of the volume that should be fine.  \n\nYou can use \\*any\\* dd version you have or are familiar with, otherwise get the dsfo from the dsfok toolkit:  \n[http://members.ozema...ware/index.html](http://members.ozemail.com.au/~nulifetv/freezip/freeware/index.html \"External link\")  \n[http://members.ozema...eware/dsfok.zip](http://members.ozemail.com.au/~nulifetv/freezip/freeware/dsfok.zip \"External link\")  \n\nOpen a command prompt in the directory on hard disk where you extract the dsfo.exe and run the command (still assuming that U: is the drive letter):  \ndsfo \\\\\\\\.\\\\U: 0 8192 BSbackupU.bin  \nthis will create in that same directory the file BSbackupU.bin 8192 (i.e. 16 sectors) in size that, in case of issues, can always be restored.  \n\nPost if you have any doubt or get any error.  \n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)  \nWonko  \n\nEDIT:\n\u003e So, I really don\u0027t know what I am doing :smile: but found some threads and tried this if it can help:\n\nYep. :smile: but that is normal.  \n\ntry:  \nmbrview.g4b (hd0)  \nand  \nmbrview.g4b (hd1)  \n\nand you will have probably better results (the \"(rd)\" device is a grub4dos **r** am**d**isk that you are not using at all and that is not initialized).\n\n"
    },
    {
      "id": "204859",
      "timestamp": "2017-11-15T16:39:25+00:00",
      "author": "matrix.rebooted",
      "content": "(didn\u0027t mentioned mbrview hd0 or hd1 because it was all 0 value everywhere)  \n\nOk, loud and clear! :smile: All things put together in the right order, here\u0027s the procedure:\n\ndrive is H: and syslinux.cfg is in /multiboot (no syslinux directory)  \n\nSince grldr was the one from HBCD, which boot directly to HBCD, I took a fresh one from make_e2b and copied it as \\\\bootgmr on the usb. That gave me direct acess to grub console.  \n\nFound correct version of syslinux.exe here [https://www.kernel.o...zip/bios/win32/](https://www.kernel.org/pub/linux/utils/boot/syslinux/6.03.zip/bios/win32/ \"External link\")  \n\n1st, bckup first 16 sectors, from dsfok directory:  \ndsfo \\\\\\\\.\\\\H: 0 8192 BSbackupU.bin  \n\n2nd, re/create syslinux PBR, open cmd prompt in H:/multiboot/  \nsyslinux.exe -f -d /multiboot/ -i H: H:\\\\multiboot\\\\syslinux.bin  \n\n3rd, reboot, from grub4dos cli:  \nroot  \nchainloader /multiboot/syslinux.bin  \nboot  \n\n4th, re/install syslinux MBR. From your first link, cmd should be:  \nsyslinux.exe --mbr --active --directory /multiboot/ --install h:  \n\nAfter \u0027access refused\u0027 msg, I quit qemu and delete the \\\\bootmgr file created at the beginning, then it was ok!  \n\nRebooted and ... yes, baby!.. :smile: recovered everything!\n\n(edit: backup again the correct bootsector this time)\n\nI could have rebuild the usb, but it would have been less funny :smile:  \n\nThank you a lot for your time and the clear explanations for the nub I am, I learned some tricks:)\n\n**Edited by matrix.rebooted, 15 November 2017 - 05:02 PM.**\n"
    },
    {
      "id": "204860",
      "timestamp": "2017-11-15T19:40:11+00:00",
      "author": "Wonko the Sane",
      "content": "Very good :smile:.\n\nA small word of warning/advice.\n\nThe bootsector (which is not anymore a bootsector, as it is multiple sectors) or PBR (Partition Boot Record) or more properly VBR (Volume Boot Record) on a NTFS filesystem is \\*always\\* 16 sectors or 8192 bytes.\n\nOn a FAT32 filesystem it can be 1 to 3 sectors depending on a number of factors, and - to further complicate the matter - some formatting utilities (including the standard MS ones) make a backup of the (3 in this case) sectors to sectors 6,7,8 and if the filesystem was created under 2K/XP and later, some code will be in the 13th sector (sector 12), and if the FAT32 was made in ReactOS on the 15th sector (sector 14).\n\nUsually (but it depends as said on a number of factors) when the FAT32 filesystem is created a number of sectors greater than 16 are marked as \"reserved\", and since these sectors (past sector 12 or 13th sector or in the case of ReactOS sector 14 or 15th sector) are blank, the assumption that 16 sectors do represent a restorable boot code is generally speaking \"good enough\".\n\nTwo issues are however possible *in theory*:\n\n1) the backup of the boot record on sectors 6,7 and 8 is non-present or not updated to the \"main,current\" boot record\n\n2) the formatting was made very \"tight\", with \"peculiar\" tools and non-standard settings and a number smaller than 16 reserved sectors was used, in this case when you image the first 16 sectors the copy may include one or more sectors from the FAT.\n\nIssue #1 is not a real issue, since the backup of the boot record is never used if not in some very rare case of filesystem recovery.\n\nIssue #2 is generally not an issue on \"populated by automatic tools\" USB sticks, as the FAT present in the very first few sectors is normally never modified (but you never know).\n\nSo, for FAT32 to make sure that your copy/image of the boot record is actually \"100% restorable\" you should check that the field at offset 14 (0x0E), two bytes, is equal to or bigger than 0x0010 (the field is the one corresponding to \"reserved sectors\".\n\nYou can use a hex/disk editor (or grub4dos or any bootsector viewer) to check the file, 99.99% of cases the value will be bigger, I just checked a similar USB stick and the value is in hex view 22 00 that is read as 0x022\u003d34 decimal.\n\nIf you want to perform this check and don\u0027t know how to do it, post and I\u0027ll give you instructions.\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204863",
      "timestamp": "2017-11-16T01:27:39+00:00",
      "author": "matrix.rebooted",
      "content": "wow! a bit advanced for me  \n\nso, I see this\n\n[https://imgur.com/yAN9wXL](https://imgur.com/yAN9wXL \"External link\")\n\ncould it be BA 08? (0x8ba\u003d2234) ?  \n\n\u003cbr /\u003e\n\n"
    },
    {
      "id": "204864",
      "timestamp": "2017-11-16T10:43:04+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e wow! a bit advanced for me  \n\u003e\n\u003e so, I see this\n\u003e\n\u003e [https://imgur.com/yAN9wXL](https://imgur.com/yAN9wXL \"External link\")\n\u003e\n\u003e could it be BA 08? (0x8ba\u003d2234) ?  \n\u003e\nYes, that is correct. ![:thumbsup:](http://reboot.pro/public/style_emoticons/default/thumbsup.gif)\n\nEverything is fine and dandy. :smile:.\n\nAs a side-side note and JFYI, conventionally hex viewers are used setting a width of 16 bytes (this way positions or offsets on the left are multiples of 16 and read in hex 0x00, 0x10, 0x20, etc.), I am so much in the habit of looking at bootsectors and MBR\u0027s in that view that at first sight I couldn\u0027t interpret the screenshot :blush: as in the \"usual\" view the wanted bytes are the last two bytes in first row (and thus easy to spot).\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    },
    {
      "id": "204875",
      "timestamp": "2017-11-16T20:18:42+00:00",
      "author": "matrix.rebooted",
      "content": "ok,\n\nthank you again!\n\n\\[solved\\] :smile:\n\n"
    },
    {
      "id": "204877",
      "timestamp": "2017-11-17T10:35:25+00:00",
      "author": "Wonko the Sane",
      "content": "\u003e ok,\n\u003e\n\u003e thank you again!\n\u003e\n\u003e \\[solved\\] :smile:\n\nNot only :smile:, you also showed that after all it wasn\u0027t too advanced for you :wink: (or for anyone, the limit is the sky).\n\n![:duff:](http://reboot.pro/public/style_emoticons/default/duff.gif)\n\nWonko\n\n"
    }
  ]
}